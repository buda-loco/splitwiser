---
phase: 11-analytics-export-and-categories
plan: 15
type: execute
depends_on: ["11-01"]
files_modified: [lib/db/stores.ts, components/ExpenseForm.tsx, hooks/useTemplates.ts]
---

<objective>
Link templates to categories for smart auto-suggestions during expense creation.

Purpose: Streamline expense entry by suggesting relevant templates based on selected category.
Output: Category-template associations, template auto-suggestions in ExpenseForm, "Save as template" quick action.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-analytics-export-and-categories/11-01-SUMMARY.md
@.planning/phases/08-templates-and-efficiency-features/08-04-SUMMARY.md
@components/ExpenseForm.tsx
@components/TemplateForm.tsx
@lib/db/stores.ts

**From 11-01:** Category system with PREDEFINED_CATEGORIES + custom categories
**From Phase 8:** Template system with CRUD operations
**Established patterns:** Template picker in ExpenseForm, smart suggestions based on tags
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add category linking to templates</name>
  <files>lib/db/stores.ts, components/TemplateForm.tsx</files>
  <action>Add category_id field to templates table (IndexedDB schema update to v8 or next available version). Update createTemplate() and updateTemplate() to accept category_id. Update TemplateForm component to include CategoryPicker (from 11-01) for selecting template category (optional field). When user selects category while creating template, save category_id with template. For existing templates without category, show "Uncategorized" badge. Add getCategoryTemplates(categoryId) function that returns templates filtered by category. Update getTemplates() to optionally filter by category.</action>
  <verify>Templates table includes category_id, TemplateForm shows CategoryPicker, creating template with category saves category_id, getCategoryTemplates returns filtered templates</verify>
  <done>Templates linked to categories with filtering capabilities</done>
</task>

<task type="auto">
  <name>Task 2: Auto-suggest templates when category selected</name>
  <files>components/ExpenseForm.tsx, hooks/useTemplates.ts</files>
  <action>Update ExpenseForm: When user selects category in CategoryPicker (Step 1), automatically show template suggestions if any templates exist for that category. Display suggestions as horizontal scrollable cards below category picker: "Quick apply: [template name]" with participant count badge (e.g., "3 people"). Max 3 suggestions shown. Clicking suggestion applies template (pre-fills participants and splits, just like existing template picker from Phase 8). If no category-specific templates exist, show generic suggestions based on participant history (existing behavior). Use Framer Motion for suggestion cards entrance (stagger animation). Create useCategoryTemplates(categoryId) hook that returns templates sorted by usage frequency (track usage count in template metadata).</action>
  <verify>Selecting category in ExpenseForm shows template suggestions, clicking suggestion applies template, no suggestions if category has no templates, animations smooth, TypeScript compiles</verify>
  <done>Smart template auto-suggestions based on category selection</done>
</task>

<task type="auto">
  <name>Task 3: Add "Save as template" quick action</name>
  <files>components/ExpenseForm.tsx</files>
  <action>Add "Save as template" button at bottom of ExpenseForm (Step 3: Review, after splits are configured). Button appears only when: expense has participants, splits are configured, and is not already loading from a template. Clicking button opens inline modal/sheet: "Save as Template?" with template name input (pre-filled with expense description), optional category (pre-filled with expense category), "Save" and "Cancel" buttons. On save: create template with current participants, splits, and category using createTemplate(). Show success toast: "Template saved! You can reuse it from the templates page." Button styled with ios-blue icon (Bookmark from Lucide) and "Save as template" label. Use Framer Motion for modal slide-up animation.</action>
  <verify>"Save as template" button appears when conditions met, clicking opens modal, saving creates template correctly, toast displays, modal dismisses, TypeScript compiles</verify>
  <done>"Save as template" quick action in expense creation flow</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Templates table includes category_id field
- [ ] TemplateForm allows category selection
- [ ] Creating template with category saves correctly
- [ ] Selecting category in ExpenseForm shows relevant templates
- [ ] Template suggestions sorted by usage frequency
- [ ] Clicking suggested template applies it
- [ ] "Save as template" button appears when applicable
- [ ] Modal opens and creates template successfully
- [ ] Success toast displays after saving
- [ ] All animations smooth and iOS-native
</verification>

<success_criteria>

- All tasks completed
- Templates intelligently linked to categories
- Auto-suggestions streamline expense creation
- "Save as template" makes template creation effortless
- iOS-native UX maintained
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-15-SUMMARY.md`
</output>
