---
phase: 11-analytics-export-and-categories
plan: 13
type: execute
depends_on: ["11-12"]
files_modified: [lib/notifications/triggers.ts, app/settings/notifications/page.tsx, components/NotificationPreferences.tsx, lib/db/stores.ts]
---

<objective>
Implement notification triggers for key events and build notification preferences screen.

Purpose: Automatically notify users about expense sharing and settlement requests, with granular control.
Output: Notification triggers on expense/settlement events, preferences UI for per-event toggles.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-analytics-export-and-categories/11-12-SUMMARY.md
@lib/actions/sendPushNotification.ts
@lib/db/stores.ts

**From 11-12:** sendPushNotification() utility, push subscription infrastructure
**Established patterns:** Event hooks in expense/settlement CRUD operations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification triggers for expense events</name>
  <files>lib/notifications/triggers.ts, lib/db/stores.ts</files>
  <action>Create notification trigger functions: 1) notifyExpenseShared(expenseId, participantIds) - sends push to all participants when expense created with them. Notification: "New Expense: [description]" / "[payer] added a [amount] expense". 2) notifyExpenseUpdated(expenseId, participantIds) - sends push when expense amount/splits change significantly (>10% change). Notification: "Expense Updated: [description]" / "[payer] updated the expense details". Integrate triggers into createExpense() and updateExpense() in stores.ts: after optimistic update succeeds, call trigger functions. Check user notification preferences before sending (from notification_preferences table). Skip notification if user is the one who created/updated (don't notify yourself). Queue notifications in IndexedDB if offline, send when reconnected.</action>
  <verify>Creating expense with participants triggers notifyExpenseShared, participants receive push notifications, updating expense triggers notifyExpenseUpdated, self-notifications skipped</verify>
  <done>Expense event notification triggers integrated into CRUD operations</done>
</task>

<task type="auto">
  <name>Task 2: Add notification trigger for settlements</name>
  <files>lib/notifications/triggers.ts, lib/db/stores.ts</files>
  <action>Create notifySettlementRequested(settlementId, toUserId, fromUserId) trigger - sends push to toUserId when fromUserId records a settlement. Notification: "Settlement Recorded" / "[fromUser] recorded a [amount] settlement". Integrate into createSettlement() in stores.ts. Check notification preferences before sending. Skip if user disabled settlement notifications. Include deep link in notification data to open /settlements/[id] when clicked. Use sendPushNotification() from 11-12.</action>
  <verify>Recording settlement triggers notifySettlementRequested, recipient receives push, notification click opens settlement detail, preferences respected</verify>
  <done>Settlement event notification trigger integrated</done>
</task>

<task type="auto">
  <name>Task 3: Build notification preferences UI</name>
  <files>app/settings/notifications/page.tsx, components/NotificationPreferences.tsx, lib/db/stores.ts</files>
  <action>Create /settings/notifications page with NotificationPreferences component. Show toggle switches for each notification type: 1) "New expenses shared with you" (default: ON), 2) "Expense updates" (default: ON), 3) "Settlement requests" (default: ON). Add master toggle at top: "Enable Push Notifications" (controls Notification permission and all toggles). If permission denied, show "Enable in System Settings" message with instructions. Save preferences to notification_preferences table in IndexedDB: user_id, expense_shared (boolean), expense_updated (boolean), settlement_requested (boolean). Create getNotificationPreferences(userId) and updateNotificationPreferences(userId, prefs) functions in stores.ts. Use iOS-native toggle switches (like Settings app) with labels and descriptions. Add link from main settings to /settings/notifications. Style with proper spacing, dividers, and dark mode.</action>
  <verify>Notification preferences page loads, toggles work, preferences save to IndexedDB, master toggle controls permission, link from settings works, dark mode works</verify>
  <done>Notification preferences UI with per-event toggles and persistence</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Creating expense triggers notification to participants
- [ ] Updating expense triggers notification if significant change
- [ ] Recording settlement triggers notification to recipient
- [ ] Self-notifications skipped (don't notify creator)
- [ ] Notification preferences page functional
- [ ] Toggle switches save preferences to IndexedDB
- [ ] Triggers respect user preferences (don't send if disabled)
- [ ] Notification click opens relevant page
- [ ] Offline notifications queued and sent on reconnect
</verification>

<success_criteria>

- All tasks completed
- Notifications triggered on key events
- Preferences provide granular control
- Users receive timely, relevant notifications
- iOS-native toggle UX
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-13-SUMMARY.md`
</output>
