---
phase: 11-analytics-export-and-categories
plan: 12
type: execute
depends_on: []
files_modified: [public/sw.js, lib/notifications/pushSetup.ts, components/NotificationPermission.tsx, lib/actions/sendPushNotification.ts]
---

<objective>
Setup push notification infrastructure with service worker registration, VAPID keys, and Supabase Edge Function.

Purpose: Enable real-time notifications for expense sharing and settlement requests.
Output: Push notification permission flow, service worker with push handler, Edge Function for sending notifications.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@public/sw.js

**Tech stack available:** Web Push API (native browser API), Supabase Edge Functions for server-side push
**Decision:** Use Web Push API (no third-party service needed, works on iOS 16.4+, free)
**Current state:** Service worker exists for PWA offline functionality
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup service worker push handler</name>
  <files>public/sw.js, lib/notifications/pushSetup.ts</files>
  <action>Update service worker (sw.js) to handle push events. Add push event listener that receives notification payload and displays using self.registration.showNotification() with iOS-style notification (title, body, icon, badge, data). Add notificationclick event listener to open app at relevant page (e.g., /expenses/[id] for expense notifications). Create generateVAPIDKeys() utility in pushSetup.ts using web-push library (npm install web-push): generate public/private VAPID key pair, store in .env.local (NEXT_PUBLIC_VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY). Create registerPushNotifications(userId) function that: 1) Requests permission using Notification.requestPermission(), 2) Registers service worker if not registered, 3) Subscribes to push using pushManager.subscribe with VAPID public key, 4) Sends subscription to Supabase (save to push_subscriptions table), 5) Returns subscription object. Handle errors gracefully (permission denied, unsupported browser).</action>
  <verify>Service worker handles push events, VAPID keys generated, registerPushNotifications saves subscription to database, TypeScript compiles</verify>
  <done>Service worker push handler and registration utility with VAPID keys</done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationPermission component</name>
  <files>components/NotificationPermission.tsx</files>
  <action>Create NotificationPermission modal component that requests push permission. Styled as iOS-native permission dialog: 1) Title: "Stay Updated", 2) Description: "Get notified when expenses are shared with you or settlements are requested", 3) App icon at top, 4) Two buttons: "Allow Notifications" (ios-blue) and "Not Now" (gray). Show only if: a) Notification permission is "default" (not granted/denied), b) User has not dismissed in last 30 days (track in localStorage). On "Allow", call registerPushNotifications(). On "Not Now", save dismissal timestamp to localStorage. Use Framer Motion for modal entrance (slide from bottom). Match iOS permission dialog styling exactly. Show success message if permission granted: "You're all set! We'll notify you about expense updates."</action>
  <verify>NotificationPermission modal displays correctly, "Allow" button requests permission and registers push, "Not Now" dismisses and saves timestamp, iOS styling accurate</verify>
  <done>iOS-native permission request modal with smart display logic</done>
</task>

<task type="auto">
  <name>Task 3: Create Supabase Edge Function for sending push</name>
  <files>lib/actions/sendPushNotification.ts</files>
  <action>Create sendPushNotification(userId, notification) server action (or Supabase Edge Function if preferred). Accept params: userId (who to notify), title (string), body (string), data (object with expenseId, settlementId, etc.). Steps: 1) Fetch user's push subscriptions from push_subscriptions table, 2) For each subscription, send push using web-push library: webpush.sendNotification(subscription, JSON.stringify({title, body, data}), {vapidDetails}), 3) Handle errors (expired subscription = delete from database, other errors = log and continue), 4) Return success count. Create push_subscriptions table if not exists: id, user_id, subscription (JSON), created_at, device_info (optional). Add RLS policies: users can only read/write their own subscriptions.</action>
  <verify>sendPushNotification function exists, fetches subscriptions, sends push using web-push, handles expired subscriptions, TypeScript compiles</verify>
  <done>Push notification sending infrastructure with subscription management</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Service worker handles push events correctly
- [ ] VAPID keys generated and stored in .env
- [ ] registerPushNotifications saves subscription to database
- [ ] NotificationPermission modal displays with iOS styling
- [ ] Permission request works on click
- [ ] sendPushNotification function sends push to user
- [ ] Expired subscriptions cleaned up automatically
- [ ] push_subscriptions table exists with RLS
</verification>

<success_criteria>

- All tasks completed
- Push notification infrastructure functional
- Service worker handles push and notification clicks
- Permission flow iOS-native and user-friendly
- Server-side push sending ready
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-12-SUMMARY.md`
</output>
