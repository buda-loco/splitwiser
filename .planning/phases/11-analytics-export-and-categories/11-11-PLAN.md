---
phase: 11-analytics-export-and-categories
plan: 11
type: execute
depends_on: []
files_modified: [app/settings/profile/page.tsx, components/ProfileForm.tsx, components/AvatarUpload.tsx, lib/db/stores.ts]
---

<objective>
Build comprehensive user profile management with avatar upload, preferences, and validation.

Purpose: Allow users to customize their profile (name, email, currency, avatar) and manage account settings.
Output: Profile edit page, avatar upload with crop, profile update with validation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/db/stores.ts
@lib/storage/receipts.ts

**Tech stack available:** Supabase Storage for avatars, user profiles in IndexedDB
**Established patterns:** Form validation, optimistic updates, iOS-native forms
**Current state:** User profiles exist with basic fields (name, email, currency_preference), no avatar upload
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build AvatarUpload component with crop</name>
  <files>components/AvatarUpload.tsx</files>
  <action>Create AvatarUpload component for profile picture upload. Show current avatar (circular, 80px diameter) or placeholder (User icon from Lucide if no avatar). Clicking avatar opens file picker (accept="image/*"). After selection, show crop modal using react-easy-crop library (npm install react-easy-crop): circular crop area (200x200px), zoom slider, rotate buttons. Modal styled as iOS sheet with "Cancel" and "Save" buttons. On save: 1) Crop image to 200x200px circle, 2) Compress to JPEG 90% quality, 3) Upload to Supabase Storage at avatars/{userId}/avatar.jpg, 4) Return public URL. Show upload progress. Props: value (current avatar URL), onChange (callback with new URL). Use Framer Motion for modal animations. Match iOS styling with proper safe areas and dark mode.</action>
  <verify>AvatarUpload displays current avatar or placeholder, clicking opens file picker, crop modal shows after selection, cropping works, upload saves to Supabase, onChange callback receives URL</verify>
  <done>AvatarUpload component with crop, zoom, and Supabase upload</done>
</task>

<task type="auto">
  <name>Task 2: Create ProfileForm component</name>
  <files>components/ProfileForm.tsx</files>
  <action>Create ProfileForm component with fields: 1) Avatar (AvatarUpload component), 2) Name (text input, required, max 50 chars), 3) Email (email input, required, valid email format, note: "Email used for login"), 4) Default Currency (dropdown: AUD, USD, EUR, GBP, etc.), 5) Timezone (auto-detected, readonly for now). Add validation: name required and trimmed, email valid format, currency required. Use Zod schema for validation (create in lib/validation/schemas.ts if not exists). On submit, call updateUserProfile() with optimistic update. Show success toast on save, error toast on failure. Add "Save Changes" button (ios-blue, disabled if no changes or invalid). Use iOS-native input styling with labels, placeholders, and focus states. Match ExpenseForm patterns.</action>
  <verify>ProfileForm renders all fields, validation works (empty name shows error, invalid email shows error), submit calls updateUserProfile, success toast appears, TypeScript compiles</verify>
  <done>ProfileForm with validation and optimistic updates</done>
</task>

<task type="auto">
  <name>Task 3: Create profile edit page</name>
  <files>app/settings/profile/page.tsx, lib/db/stores.ts</files>
  <action>Create /settings/profile page that renders ProfileForm. Load current user profile from IndexedDB on mount (use useAuth to get userId, then getUserProfile). Add header with back button and "Edit Profile" title. Show loading skeleton while fetching profile. Update updateUserProfile() in stores.ts to handle avatar_url field (add to IndexedDB schema if missing). Add link from main settings page to profile edit ("Edit Profile" row with chevron). Include Supabase Auth email update if email changed (requires re-authentication, show warning: "Changing email requires re-login"). Use standard page layout with safe areas and dark mode support.</action>
  <verify>Page loads at /settings/profile, ProfileForm pre-populated with user data, updating profile saves to IndexedDB, avatar upload integrates correctly, link from settings works</verify>
  <done>Profile edit page with form, avatar upload, and settings integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AvatarUpload component renders and uploads to Supabase Storage
- [ ] Crop modal works with zoom and rotate
- [ ] ProfileForm displays all fields with current user data
- [ ] Form validation prevents invalid submissions
- [ ] Saving profile updates IndexedDB and Supabase
- [ ] /settings/profile page accessible from settings
- [ ] Avatar displays in profile and elsewhere in app
- [ ] Dark mode works for all profile UI
</verification>

<success_criteria>

- All tasks completed
- Profile management fully functional
- Avatar upload with crop working smoothly
- Form validation prevents errors
- iOS-native UX maintained
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-11-SUMMARY.md`
</output>
