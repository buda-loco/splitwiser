---
phase: 11-analytics-export-and-categories
plan: 08
type: execute
depends_on: []
files_modified: [app/settings/delete-account/page.tsx, lib/actions/deleteAccount.ts, lib/db/stores.ts]
---

<objective>
Implement GDPR-compliant account deletion with cascade and optional grace period.

Purpose: Honor user's right to erasure (GDPR Article 17) while preventing accidental data loss.
Output: Account deletion flow with confirmation, cascade deletion, and 30-day grace period option.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/db/stores.ts
@app/settings/export/page.tsx

**Tech stack available:** Supabase Auth for user deletion, IndexedDB for local data
**Established patterns:** Confirmation dialogs, iOS-native settings pages
**Current state:** Data export exists, but no account deletion
**GDPR requirement:** Users must be able to request complete data erasure
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account deletion confirmation flow</name>
  <files>app/settings/delete-account/page.tsx</files>
  <action>Create /settings/delete-account page with multi-step confirmation: Step 1) Warning screen explaining consequences (all expenses, settlements, and history will be deleted, cannot be undone). Step 2) Verification input (type "DELETE" to confirm). Step 3) Optional grace period selection: "Delete immediately" or "Delete in 30 days" (allows recovery if accidental). Step 4) Email confirmation sent with cancellation link (if grace period selected). Use iOS-native styling with prominent warning colors (ios-red for destructive action). Add back button at each step. Show countdown if grace period active. Add "Download my data first" button linking to /settings/export before deletion.</action>
  <verify>Page loads at /settings/delete-account, all confirmation steps display, typing "DELETE" enables confirm button, grace period option works</verify>
  <done>Account deletion confirmation flow with multi-step verification and grace period</done>
</task>

<task type="auto">
  <name>Task 2: Implement cascade deletion logic</name>
  <files>lib/actions/deleteAccount.ts</files>
  <action>Create deleteAccount(userId, gracePeriod?) server action. If gracePeriod=true, set deletion_scheduled_at = now() + 30 days in user profile, send email with cancellation link, return success. If immediate deletion, perform cascade: 1) Soft delete all expenses created by user (set is_deleted=true, deleted_at=now()), 2) Soft delete all settlements from/to user, 3) Delete all expense versions for user's expenses, 4) Delete user profile from IndexedDB, 5) Call Supabase auth.admin.deleteUser(userId) to remove auth account. Wrap in transaction if possible. On error, rollback and return error message. For grace period cancellation, create cancelAccountDeletion(userId) that clears deletion_scheduled_at.</action>
  <verify>deleteAccount cascades correctly through all data, Supabase user deleted, grace period sets scheduled deletion, cancellation clears schedule</verify>
  <done>Account deletion with cascade to all user data and grace period support</done>
</task>

<task type="auto">
  <name>Task 3: Add deletion settings and scheduled deletion banner</name>
  <files>lib/db/stores.ts, app/settings/page.tsx</files>
  <action>Add "Delete My Account" button in /settings page under "Danger Zone" section (ios-red background, prominent warning icon). On click, navigate to /settings/delete-account. If user has scheduled deletion (deletion_scheduled_at exists and future), show persistent banner at top of all pages: "Your account is scheduled for deletion on [date]. [Cancel deletion]" with countdown in days. Banner styled with ios-red background, dismissible but persists across sessions. Add checkDeletionSchedule() function that runs on app load to check if deletion_scheduled_at has passed - if so, trigger deleteAccount immediately. Link to deletion settings from main settings list.</action>
  <verify>Delete account button appears in settings, clicking navigates to confirmation flow, scheduled deletion banner displays with countdown, banner dismissible</verify>
  <done>Deletion settings integrated with scheduled deletion notifications</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /settings/delete-account page loads with confirmation steps
- [ ] Typing "DELETE" verification works
- [ ] Grace period option functional
- [ ] deleteAccount() cascades through all user data
- [ ] Supabase user account deleted successfully
- [ ] Scheduled deletion banner displays with countdown
- [ ] Cancellation link clears scheduled deletion
- [ ] "Delete My Account" button in settings
</verification>

<success_criteria>

- All tasks completed
- GDPR right to erasure implemented
- Multi-step confirmation prevents accidents
- Grace period provides safety net
- Cascade deletion complete and correct
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-08-SUMMARY.md`
</output>
