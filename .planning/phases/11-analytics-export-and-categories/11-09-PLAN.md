---
phase: 11-analytics-export-and-categories
plan: 09
type: execute
depends_on: []
files_modified: [lib/storage/receipts.ts, components/ReceiptUpload.tsx, supabase/migrations/]
---

<objective>
Setup receipt upload infrastructure with Supabase Storage, compression, and validation.

Purpose: Enable users to attach receipt photos to expenses for record-keeping and verification.
Output: Supabase Storage bucket configuration, upload component with camera/file picker, thumbnail compression.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Tech stack available:** Supabase Storage for file hosting, browser File API and Canvas API for compression
**Decision:** Use Supabase Storage (free tier: 1GB storage, integrates with existing Supabase setup, built-in CDN)
**Established patterns:** Optimistic updates, offline-first (upload queued if offline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup Supabase Storage bucket</name>
  <files>supabase/migrations/YYYYMMDDHHMMSS_create_receipts_bucket.sql</files>
  <action>Create Supabase migration to configure Storage bucket named "receipts". Set bucket policies: public read access (receipts accessible via URL), authenticated upload only (only logged-in users can upload). Add RLS policies: users can upload to their own folder (receipts/{user_id}/{expense_id}/{filename}), users can delete their own receipts. Set file size limit: 5MB per file. Allowed MIME types: image/jpeg, image/png, image/webp, image/heic (iOS photos). Add storage quota check: max 50 receipts per user. Test bucket creation with supabase CLI.</action>
  <verify>Migration runs successfully, receipts bucket exists in Supabase dashboard, RLS policies applied, file size limit enforced</verify>
  <done>Supabase Storage bucket configured with security policies and limits</done>
</task>

<task type="auto">
  <name>Task 2: Build ReceiptUpload component</name>
  <files>components/ReceiptUpload.tsx</files>
  <action>Create ReceiptUpload component with two upload modes: 1) Camera capture (mobile only, use input type="file" accept="image/*" capture="environment" for rear camera), 2) File picker (desktop/mobile, accept image formats). Props: expenseId, onUpload (callback with file URL). Show upload button with Camera icon (Lucide) on mobile, ImagePlus icon on desktop. Display upload progress (0-100%) with iOS-style progress bar during upload. After upload, show thumbnail preview (100x100px) with remove button (X icon). Use Framer Motion for thumbnail entrance animation. Match iOS styling with rounded corners, shadows, and dark mode. Handle upload errors with toast notification.</action>
  <verify>ReceiptUpload renders, clicking button opens camera on mobile/file picker on desktop, selecting image shows preview, onUpload callback receives file URL</verify>
  <done>ReceiptUpload component with camera/file picker and preview</done>
</task>

<task type="auto">
  <name>Task 3: Implement image compression before upload</name>
  <files>lib/storage/receipts.ts</files>
  <action>Create compressImage(file, maxWidth=1200, quality=0.8) function using Canvas API. Steps: 1) Load image into Image element, 2) Calculate scaled dimensions (maintain aspect ratio, max width 1200px), 3) Draw to canvas at scaled size, 4) Convert to Blob with 80% JPEG quality, 5) Return compressed Blob. Create uploadReceipt(expenseId, file, userId) function: 1) Compress image, 2) Generate unique filename: {timestamp}_{random}.jpg, 3) Upload to Supabase Storage path: receipts/{userId}/{expenseId}/{filename}, 4) Return public URL. Handle offline: if no network, queue upload to IndexedDB pending_uploads store, retry on reconnection. Add getReceiptUrl(path) helper to generate public URL from storage path.</action>
  <verify>compressImage reduces file size significantly, uploadReceipt saves to correct Supabase Storage path, returns valid public URL, offline queueing works</verify>
  <done>Image compression and upload utilities with offline support</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Supabase Storage bucket "receipts" exists
- [ ] RLS policies allow user uploads to their own folders
- [ ] File size limit (5MB) enforced
- [ ] ReceiptUpload component renders correctly
- [ ] Camera opens on mobile, file picker on desktop
- [ ] Image compression reduces file size
- [ ] Upload saves to Supabase Storage successfully
- [ ] Public URL returned and accessible
- [ ] Offline upload queueing functional
</verification>

<success_criteria>

- All tasks completed
- Supabase Storage infrastructure ready
- Upload component functional with camera/file picker
- Image compression working (reduces size by ~60-70%)
- Offline uploads queued correctly
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-09-SUMMARY.md`
</output>
