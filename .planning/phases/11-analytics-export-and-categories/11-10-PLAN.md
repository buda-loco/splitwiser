---
phase: 11-analytics-export-and-categories
plan: 10
type: execute
depends_on: ["11-09"]
files_modified: [lib/db/indexeddb.ts, components/ExpenseForm.tsx, components/ReceiptGallery.tsx, app/expenses/[id]/page.tsx]
---

<objective>
Integrate receipt upload into expense flow and build receipt gallery viewer with zoom/delete.

Purpose: Allow users to attach and view receipt photos for expenses, making expense tracking more complete.
Output: Receipt attachment in expense creation/edit, receipt gallery component, receipt display in expense detail.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-analytics-export-and-categories/11-09-SUMMARY.md
@components/ExpenseForm.tsx
@components/ReceiptUpload.tsx
@lib/storage/receipts.ts

**From 11-09:** ReceiptUpload component, uploadReceipt() utility, Supabase Storage bucket
**Established patterns:** Multi-step expense form, sheet modals for detail views
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add receipt_urls to expense schema</name>
  <files>lib/db/indexeddb.ts</files>
  <action>Add receipt_urls field (array of strings) to expenses table in IndexedDB schema. Run migration to v7. Each string is a Supabase Storage public URL. Update createExpense() and updateExpense() to accept receipt_urls array. Update expense TypeScript type to include receipt_urls?: string[]. For backward compatibility, default to empty array if field missing. Update expense CRUD operations to handle receipt_urls in optimistic updates and sync.</action>
  <verify>Database migration succeeds, expenses table includes receipt_urls field, createExpense accepts receipt_urls, TypeScript compiles</verify>
  <done>Expense schema updated with receipt_urls array field</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ReceiptUpload into ExpenseForm</name>
  <files>components/ExpenseForm.tsx</files>
  <action>Add ReceiptUpload component to ExpenseForm in Step 1 (Basic Details), below category picker. Add form state: receiptUrls (string[]). When user uploads receipt via ReceiptUpload, call uploadReceipt() (from 11-09) and add returned URL to receiptUrls array. Display uploaded receipts as thumbnail grid (3 columns) with remove button on each. On form submit, include receiptUrls in expense object passed to createExpense/updateExpense. For edit mode, load existing receipt_urls from initialData and populate receiptUrls state. Add upload limit: max 5 receipts per expense (show warning if user tries to add more). Style thumbnails with rounded corners, shadows, iOS-native spacing.</action>
  <verify>ReceiptUpload appears in ExpenseForm, uploading adds to receiptUrls array, thumbnails display in grid, removing works, form submit includes receipt_urls, edit mode loads existing receipts</verify>
  <done>Receipt upload integrated into expense creation and edit flow</done>
</task>

<task type="auto">
  <name>Task 3: Build ReceiptGallery viewer component</name>
  <files>components/ReceiptGallery.tsx, app/expenses/[id]/page.tsx</files>
  <action>Create ReceiptGallery component that displays receipt images with: 1) Thumbnail grid (3 columns, tap to enlarge), 2) Full-screen viewer on tap (uses Sheet modal), 3) Pinch-to-zoom in full-screen (use native CSS transform: scale or library like react-pinch-zoom-pan), 4) Swipe to navigate between receipts (Framer Motion drag), 5) Delete button in full-screen view (trash icon, confirmation dialog). Props: receiptUrls, onDelete (callback with URL to delete). Full-screen viewer has dark overlay background, close button (X icon top-right), and current receipt index indicator (e.g., "2 of 5"). Use iOS-native transitions (sheet slide-up for full-screen). Integrate ReceiptGallery into expense detail page (app/expenses/[id]/page.tsx) below expense details if receipt_urls exists.</action>
  <verify>ReceiptGallery displays thumbnail grid, tapping opens full-screen viewer, pinch-zoom works, swipe navigation works, delete button functional, close button exits full-screen</verify>
  <done>ReceiptGallery component with zoom, swipe, and delete</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Receipt upload and gallery with camera capture, compression, and full-screen viewer</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Navigate to /expenses/new
    3. Test receipt upload: click camera/image icon in ExpenseForm
    4. On mobile: verify camera opens (rear camera). On desktop: verify file picker opens
    5. Select/capture an image - verify compression happens (check network tab for file size)
    6. Verify thumbnail appears in ExpenseForm below upload button
    7. Upload 2-3 more receipts - verify grid layout (3 columns)
    8. Try uploading 6th receipt - verify error message (max 5)
    9. Create expense with receipts attached
    10. Navigate to expense detail page - verify ReceiptGallery displays
    11. Tap receipt thumbnail - verify full-screen viewer opens with sheet animation
    12. Test pinch-to-zoom on receipt image
    13. Swipe left/right to navigate between receipts
    14. Tap delete button - verify confirmation, then delete removes receipt
    15. Test dark mode - verify all receipt UI elements visible
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] receipt_urls field added to expenses table
- [ ] ReceiptUpload integrated into ExpenseForm
- [ ] Uploading receipt adds to form state
- [ ] Thumbnails display correctly in grid
- [ ] Max 5 receipts limit enforced
- [ ] ReceiptGallery component functional
- [ ] Full-screen viewer opens on tap
- [ ] Pinch-zoom works in full-screen
- [ ] Delete receipt functional
- [ ] User verification checkpoint passed
</verification>

<success_criteria>

- All tasks completed
- Receipt upload fully integrated into expense flow
- ReceiptGallery provides excellent photo viewing UX
- iOS-native interactions (pinch, swipe, sheet)
- User approval received
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-export-and-categories/11-10-SUMMARY.md`
</output>
