---
phase: 08-templates-and-efficiency-features
plan: 03
type: execute
depends_on: ["08-01"]
files_modified: [components/ExpenseForm.tsx, hooks/useTemplates.ts]
---

<objective>
Integrate quick-apply template functionality into expense creation flow.

Purpose: Allow users to select a saved template when creating an expense, automatically filling participants and split configuration.
Output: Template selector in ExpenseForm with one-click apply that populates participants and splits.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-templates-and-efficiency-features/08-01-SUMMARY.md
@components/ExpenseForm.tsx
@lib/db/types.ts
@lib/db/stores.ts
@hooks/useParticipants.ts

**Tech stack available:** Next.js 15, React, TypeScript, Tailwind, Framer Motion
**Established patterns:**
- React hooks for data fetching (useParticipants, useBalances)
- iOS-native UI with Framer Motion animations
- Multi-step forms with state management

**From 08-01:**
- Template types and CRUD operations available
- getTemplatesByUser(userId) returns templates for user
- getTemplateById(templateId) returns template with participants

**ExpenseForm current structure:**
- 3-step flow: basic → participants → splits
- Participants selected via ParticipantPicker
- Split method selected and configured in splits step
- State: participants[], splitMethod, splits[]
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTemplates hook for template data fetching</name>
  <files>hooks/useTemplates.ts</files>
  <action>
Create React hook following useParticipants.ts pattern:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { getTemplatesByUser, getTemplateById } from '@/lib/db/stores';
import type { OfflineSplitTemplate, TemplateParticipant } from '@/lib/db/types';

export type TemplateWithParticipants = {
  template: OfflineSplitTemplate;
  participants: TemplateParticipant[];
};

/**
 * Hook to fetch templates for current user
 */
export function useTemplates(userId: string | null) {
  const [templates, setTemplates] = useState<OfflineSplitTemplate[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!userId) {
      setTemplates([]);
      setLoading(false);
      return;
    }

    async function loadTemplates() {
      try {
        const userTemplates = await getTemplatesByUser(userId);
        setTemplates(userTemplates);
      } catch (error) {
        console.error('Failed to load templates:', error);
        setTemplates([]);
      } finally {
        setLoading(false);
      }
    }

    loadTemplates();
  }, [userId]);

  return { templates, loading };
}

/**
 * Hook to fetch a single template with participants
 */
export function useTemplate(templateId: string | null) {
  const [data, setData] = useState<TemplateWithParticipants | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!templateId) {
      setData(null);
      setLoading(false);
      return;
    }

    async function loadTemplate() {
      try {
        const result = await getTemplateById(templateId);
        setData(result);
      } catch (error) {
        console.error('Failed to load template:', error);
        setData(null);
      } finally {
        setLoading(false);
      }
    }

    loadTemplate();
  }, [templateId]);

  return { data, loading };
}
```

Follow existing hook patterns: useState for data/loading, useEffect for fetching, error handling with console.error.
  </action>
  <verify>TypeScript compiles without errors, hook exports types and functions</verify>
  <done>useTemplates hook created following existing patterns, exports TemplateWithParticipants type</done>
</task>

<task type="auto">
  <name>Task 2: Add template selector to ExpenseForm participants step</name>
  <files>components/ExpenseForm.tsx</files>
  <action>
Integrate template quick-apply into ExpenseForm:

**1. Add useTemplates hook at top of component:**
```typescript
const userId = 'temp-user-id'; // TODO: Get from auth context
const { templates } = useTemplates(userId);
```

**2. Add template selector UI ABOVE ParticipantPicker in participants step:**

Create a collapsible section with Framer Motion:
- Header: "Quick Apply Template" with chevron icon (tap to expand/collapse)
- When expanded: Show list of templates as pills/buttons
- Each template button shows: template.name + participant count (e.g., "Family Dinner (3 people)")
- On template click: Call applyTemplate(templateId)

**3. Implement applyTemplate function:**
```typescript
async function applyTemplate(templateId: string) {
  const result = await getTemplateById(templateId);
  if (!result) return;

  const { template, participants: templateParticipants } = result;

  // Load full participant details for each template participant
  const participantDetails = await Promise.all(
    templateParticipants.map(async (tp) => {
      if (tp.user_id) {
        // Load user details (would need getUserById - for now use placeholder)
        return {
          id: tp.user_id,
          type: 'user' as const,
          name: 'User', // TODO: Load from database
          split_value: tp.split_value
        };
      } else if (tp.participant_id) {
        const participant = await getParticipantById(tp.participant_id);
        return {
          id: tp.participant_id,
          type: 'participant' as const,
          name: participant?.name || 'Unknown',
          split_value: tp.split_value
        };
      }
      return null;
    })
  ).then(results => results.filter(Boolean));

  // Set participants
  setParticipants(participantDetails);

  // Set split method
  setSplitMethod(template.split_type);

  // Set splits based on template configuration
  const newSplits = participantDetails.map(p => ({
    id: crypto.randomUUID(),
    expense_id: '', // Will be set on save
    user_id: p.type === 'user' ? p.id : null,
    participant_id: p.type === 'participant' ? p.id : null,
    amount: 0, // Will be calculated based on expense amount
    split_type: template.split_type,
    split_value: p.split_value || null,
    created_at: new Date().toISOString()
  }));

  setSplits(newSplits);

  // Auto-advance to splits step
  setStep('splits');
}
```

**Styling:**
- Template selector: ios-gray5 background, rounded-lg, p-4
- Template buttons: ios-blue text, tap scale animation, inline-flex with gap
- Pills with participant count: ios-gray4 background, rounded-full
- Collapse animation with Framer Motion layoutId

Use getParticipantById from stores.ts (already exists from Phase 2).
Add TODO comment for getUserById (doesn't exist yet - Phase 2 has user profiles but no query by ID in stores.ts).
  </action>
  <verify>TypeScript compiles without errors, template selector renders in participants step</verify>
  <done>Template selector integrated into ExpenseForm, clicking template populates participants and splits, auto-advances to splits step</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] useTemplates hook follows existing hook patterns
- [ ] Template selector appears in participants step
- [ ] Clicking template populates participants and split configuration
- [ ] Form auto-advances to splits step after template applied
- [ ] iOS-native styling matches ExpenseForm design
</verification>

<success_criteria>

- useTemplates hook created for fetching user templates
- Template selector added to ExpenseForm participants step
- Quick-apply populates participants, split method, and splits from template
- Auto-advance to splits step after template selection
- All verification checks pass
- No TypeScript errors introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/08-templates-and-efficiency-features/08-03-SUMMARY.md`:

# Phase 8 Plan 3: Template Quick-Apply Integration Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `file.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 08-04-PLAN.md (template management UI)
</output>
