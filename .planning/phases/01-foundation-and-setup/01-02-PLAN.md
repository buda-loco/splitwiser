---
phase: 01-foundation-and-setup
plan: 02
type: execute
depends_on: [01-01]
files_modified: [.env.local, lib/supabase/client.ts, lib/supabase/server.ts, lib/supabase/middleware.ts, package.json]
---

<objective>
Setup Supabase client with SSR-safe configuration for authentication and database access.

Purpose: Establish database and authentication foundation using Supabase with proper server/client separation for Next.js App Router.
Output: Working Supabase client utilities for browser, server components, and middleware with environment configuration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-setup/01-01-SUMMARY.md

**Tech Stack:**
- Supabase for PostgreSQL database, authentication, and realtime subscriptions
- @supabase/ssr package (replaces deprecated auth-helpers)
- Cookie-based auth for SSR compatibility

**Key Requirements:**
- Separate client utilities for browser vs server contexts
- SSR-safe authentication (no token mismatches)
- Environment variables in .env.local
- Ready for Phase 2 authentication implementation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase SSR client</name>
  <files>package.json</files>
  <action>
Install Supabase SSR package:
```bash
npm install @supabase/supabase-js @supabase/ssr
```

Verify installation:
- Check package.json contains @supabase/supabase-js and @supabase/ssr
- Both should be in dependencies (not devDependencies)
  </action>
  <verify>npm list @supabase/ssr and npm list @supabase/supabase-js show installed versions</verify>
  <done>Supabase packages installed in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create environment configuration</name>
  <files>.env.local</files>
  <action>
Create .env.local file with placeholder Supabase credentials:

```
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

Add comment at top of file:
```
# Supabase Configuration
# Replace these with actual project credentials from supabase.com/dashboard
# NEXT_PUBLIC_ prefix makes these available in browser (safe for anon key)
```

Do NOT add actual credentials yet - Phase 2 will handle Supabase project creation.

Add .env.local to .gitignore if not already present:
```bash
echo ".env.local" >> .gitignore
```
  </action>
  <verify>cat .env.local shows placeholder credentials, git status shows .env.local as untracked (in .gitignore)</verify>
  <done>.env.local created with placeholder credentials and gitignored</done>
</task>

<task type="auto">
  <name>Task 3: Create browser client utility</name>
  <files>lib/supabase/client.ts</files>
  <action>
Create lib/supabase/client.ts for Client Components:

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

This utility:
- Uses createBrowserClient for client-side usage
- Accesses NEXT_PUBLIC_ env vars (available in browser)
- Returns configured Supabase client
- Will be used in Client Components with "use client" directive

Pattern for usage:
```typescript
'use client'
import { createClient } from '@/lib/supabase/client'

export default function MyComponent() {
  const supabase = createClient()
  // Use supabase.auth, supabase.from(), etc.
}
```
  </action>
  <verify>File exists at lib/supabase/client.ts, contains createClient export, imports from @supabase/ssr</verify>
  <done>Browser client utility created for Client Components</done>
</task>

<task type="auto">
  <name>Task 4: Create server client utility</name>
  <files>lib/supabase/server.ts</files>
  <action>
Create lib/supabase/server.ts for Server Components:

```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  )
}
```

This utility:
- Uses createServerClient for server-side rendering
- Integrates with Next.js cookies() for session management
- Handles cookie reading and setting (with try-catch for Server Component limitations)
- Will be used in Server Components, Server Actions, and Route Handlers

Pattern for usage:
```typescript
import { createClient } from '@/lib/supabase/server'

export default async function ServerComponent() {
  const supabase = await createClient()
  const { data } = await supabase.from('expenses').select()
  // Use data...
}
```
  </action>
  <verify>File exists at lib/supabase/server.ts, contains async createClient export, imports from @supabase/ssr and next/headers</verify>
  <done>Server client utility created for Server Components and Route Handlers</done>
</task>

<task type="auto">
  <name>Task 5: Create middleware helper (for Phase 2)</name>
  <files>lib/supabase/middleware.ts</files>
  <action>
Create lib/supabase/middleware.ts for auth token refresh:

```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value)
          })
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) => {
            supabaseResponse.cookies.set(name, value, options)
          })
        },
      },
    }
  )

  // IMPORTANT: Avoid writing any logic between createServerClient and
  // supabase.auth.getUser(). A simple mistake could make it very hard to debug
  // issues with users being randomly logged out.

  const {
    data: { user },
  } = await supabase.auth.getUser()

  // Auth logic will be added in Phase 2 (authentication implementation)
  // For now, just refresh the session if user exists

  return supabaseResponse
}
```

This utility:
- Will be called from middleware.ts (created in Phase 2)
- Refreshes auth tokens automatically on every request
- Prevents token expiration issues
- Foundation for protected routes in Phase 2

Do NOT create middleware.ts yet - that happens in Phase 2 with authentication.
  </action>
  <verify>File exists at lib/supabase/middleware.ts, contains updateSession export, imports from @supabase/ssr and next/server</verify>
  <done>Middleware helper created for auth token refresh (will be integrated in Phase 2)</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm list @supabase/ssr` shows package installed
- [ ] `.env.local` exists with placeholder credentials
- [ ] `lib/supabase/client.ts` exports createClient function
- [ ] `lib/supabase/server.ts` exports async createClient function
- [ ] `lib/supabase/middleware.ts` exports updateSession function
- [ ] All files have proper TypeScript imports (no errors)
- [ ] `npm run build` succeeds (Supabase clients don't break build)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Supabase SSR package installed
- Environment configuration ready for credentials
- Browser client utility created for Client Components
- Server client utility created for Server Components and Route Handlers
- Middleware helper ready for Phase 2 auth integration
- TypeScript compiles without errors
- Ready for Phase 2 authentication implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-setup/01-02-SUMMARY.md`:

---
phase: 01-foundation-and-setup
plan: 02
completed: [YYYY-MM-DD]
subsystem: database
requires: [01-01]
provides: [supabase-client, supabase-ssr, environment-config]
affects: [02-01, 02-02, 02-03, 02-06]
tags: [setup, supabase, database, auth]
key-decisions:
  - "@supabase/ssr package for SSR-safe auth"
  - "Separate client utilities for browser vs server contexts"
  - "Cookie-based session management"
key-files:
  - lib/supabase/client.ts
  - lib/supabase/server.ts
  - lib/supabase/middleware.ts
  - .env.local
tech-stack:
  added: [supabase-js, supabase-ssr]
  patterns: [ssr-safe-auth, cookie-session, client-server-separation]
---

# Phase 1 Plan 2: Supabase Client Configuration

**Supabase client configured with SSR-safe utilities for authentication and database access.**

## Accomplishments

- Installed @supabase/ssr package for Next.js App Router compatibility
- Created environment configuration with placeholder credentials
- Built browser client utility for Client Components
- Built server client utility for Server Components and Route Handlers
- Created middleware helper for auth token refresh (ready for Phase 2)
- Established client/server separation pattern for SSR safety

## Files Created/Modified

- `package.json` - Added @supabase/supabase-js and @supabase/ssr dependencies
- `.env.local` - Placeholder Supabase credentials (gitignored)
- `lib/supabase/client.ts` - Browser client utility (createBrowserClient)
- `lib/supabase/server.ts` - Server client utility (createServerClient with cookies)
- `lib/supabase/middleware.ts` - Auth token refresh helper (for Phase 2)

## Decisions Made

**@supabase/ssr over auth-helpers**: The auth-helpers package is deprecated. @supabase/ssr is the official Next.js integration with first-class App Router support.

**Separate client utilities**: Browser and server contexts require different Supabase client configurations. Browser uses createBrowserClient, server uses createServerClient with Next.js cookies integration.

**Cookie-based session**: Using Next.js cookies() API for session management ensures SSR compatibility and prevents auth token mismatches between server and client.

## Issues Encountered

None - standard Supabase SSR setup worked as expected.

## Next Phase Readiness

**Ready for Phase 2 authentication:**
- Client utilities ready for auth flows
- Middleware helper ready for protected routes
- Environment variables prepared for Supabase project credentials

**Pattern established:**
- Client Components: `import { createClient } from '@/lib/supabase/client'`
- Server Components: `import { createClient } from '@/lib/supabase/server'`
- Middleware: `import { updateSession } from '@/lib/supabase/middleware'`

## Next Step

Ready for parallel execution with Plans 01-03 (PWA) and 01-04 (Framer Motion). Run `/gsd:execute-phase 1` to execute remaining plans with intelligent parallelization.
</output>
