---
phase: 07-settlement-and-payments
plan: 05
type: execute
depends_on: ["07-01", "07-02", "07-03"]
files_modified: [lib/balances/calculator.ts, hooks/useBalances.ts]
---

<objective>
Integrate settlements into balance calculation so that recorded settlements reduce displayed balances correctly.

Purpose: Close the loop - settlements affect balances, making the app usable for real-world debt tracking.
Output: Balance calculation engine applies settlements, reducing displayed debts by settled amounts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-settlement-and-payments/07-01-SUMMARY.md
@.planning/phases/07-settlement-and-payments/07-02-SUMMARY.md
@.planning/phases/07-settlement-and-payments/07-03-SUMMARY.md
@.planning/phases/06-balance-calculation-engine/06-01-SUMMARY.md
@lib/balances/calculator.ts
@lib/balances/types.ts
@lib/db/types.ts
@lib/db/stores.ts

**From Phase 6:**
- calculateBalances() computes balances from expenses
- Returns BalanceEntry[] with from/to/amount/currency

**From Phase 7 Plans 01-03:**
- Settlement records exist with three types: global, tag_specific, partial
- getSettlements() fetches all settlements
- Settlement schema has from/to persons, amount, currency, type, tag

**Integration requirements:**
- Fetch settlements along with expenses
- Apply settlements to reduce balances:
  - Global settlements: reduce all balances between two people
  - Tag-specific settlements: reduce balances for that tag only
  - Partial settlements: reduce balances by amount specified
- Handle multi-currency settlements (convert if needed)
- Never show negative balances (settled debts should zero out or flip direction)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settlement application logic to calculateBalances</name>
  <files>lib/balances/calculator.ts</files>
  <action>
Update calculateBalances() to apply settlements:

Current flow:
1. Fetch expenses
2. Calculate balances from expense splits
3. Return BalanceEntry[]

New flow:
1. Fetch expenses
2. Calculate balances from expense splits (raw balances)
3. Fetch settlements via getSettlements()
4. Apply settlements to reduce balances:
   - Group settlements by person pair (from/to)
   - For each person pair, sum settlement amounts by type:
     - Global: reduce ALL balances between pair
     - Tag-specific: track per-tag settlements separately
     - Partial: reduce balances up to amount specified
5. Subtract settlement amounts from raw balances
6. Remove zero balances (fully settled)
7. Flip direction if settlement exceeds original balance
8. Return adjusted BalanceEntry[]

Settlement application algorithm:
```
For each balance entry (person A owes person B):
  total_settled = 0

  // Global settlements
  global_settlements = settlements where (from=A, to=B OR from=B, to=A) AND type='global'
  total_settled += sum(global_settlements.amount)

  // Partial settlements
  partial_settlements = settlements where (from=A, to=B) AND type='partial'
  total_settled += sum(partial_settlements.amount)

  // Tag-specific settlements (if balance has tag)
  if balance.tag:
    tag_settlements = settlements where (from=A, to=B) AND type='tag_specific' AND tag=balance.tag
    total_settled += sum(tag_settlements.amount)

  // Apply settlement
  adjusted_balance = balance.amount - total_settled

  if adjusted_balance < 0:
    // Over-settled, flip direction
    flip(balance.from, balance.to)
    adjusted_balance = abs(adjusted_balance)

  if adjusted_balance > 0:
    yield adjusted_balance
  // else: fully settled, omit from results
```

Handle multi-currency:
- Convert settlement amounts to balance currency using exchange rates
- Use existing exchange rate logic from Phase 6

Edge cases:
- Settlement between A→B when balance is B→A: apply symmetrically
- Multiple settlements between same pair: sum all applicable settlements
- Settlement exceeds balance: flip direction (person now owes the other direction)
- Settlement in different currency: convert to balance currency

This is the critical integration piece that makes settlements functional.
  </action>
  <verify>
Balance calculation includes settlements:
- Raw balances calculated from expenses
- Settlements fetched and applied
- Global settlements reduce all balances between pair
- Tag-specific settlements reduce tag balances only
- Partial settlements reduce balances by amount
- Zero balances removed from results
- Multi-currency settlements converted correctly
- TypeScript compiles without errors
  </verify>
  <done>calculateBalances applies settlements correctly. Balances reduced by settlement amounts. Global, tag-specific, and partial settlements handled. Multi-currency conversion works.</done>
</task>

<task type="auto">
  <name>Task 2: Update useBalances hook to re-calculate when settlements change</name>
  <files>hooks/useBalances.ts</files>
  <action>
Update useBalances hook to:
- Re-fetch balances when settlements are created/deleted
- Listen for IndexedDB changes on SETTLEMENTS store
- Trigger balance re-calculation on settlement change
- Maintain loading state during re-calculation

Current behavior: loads balances once on mount
New behavior: loads balances on mount AND when settlements change

Implementation:
- Add storage event listener for SETTLEMENTS store
- Add interval polling as fallback (every 5 seconds when tab active)
- Or use custom event dispatched from settlement creation/deletion
- Re-call calculateBalances() when settlement change detected
- Update balances state with new results

This ensures BalanceView updates immediately after recording a settlement.

Follow patterns from Phase 3 (real-time sync patterns).
  </action>
  <verify>
- useBalances re-calculates when settlement created
- useBalances re-calculates when settlement deleted
- BalanceView updates immediately after settlement recorded
- No unnecessary re-calculations (debounce if needed)
- Loading state shows during re-calculation
  </verify>
  <done>useBalances listens for settlement changes. Balances re-calculate automatically. BalanceView updates immediately after settlements.</done>
</task>

<task type="auto">
  <name>Task 3: Add settlement summary to BalanceView detail</name>
  <files>components/BalanceDetail.tsx</files>
  <action>
Update BalanceDetail component (expense breakdown modal) to show settlement history:

Current structure:
- Shows expenses that contribute to balance
- Groups by date
- Shows split amounts per expense

Add settlement section:
- After expense list, add "Settlements" section
- Show all settlements that reduced this balance:
  - Settlement date
  - Amount settled
  - Settlement type badge (Global/Tag/Partial)
  - "View details" link (opens settlement in SettlementHistory)
- Calculate and show:
  - Total from expenses: $X
  - Total settled: $Y
  - Remaining balance: $Z (matches balance entry amount)
- If fully settled (balance is $0), show:
  - "✓ Fully settled" badge
  - Last settlement date

Visual hierarchy:
- Expenses section first (what created the debt)
- Settlements section second (what reduced the debt)
- Summary at bottom (net result)

iOS-native styling:
- Settlement items match expense items styling
- Green text for settlement amounts (positive action)
- Divider between expenses and settlements sections
- Bold "Remaining balance" to highlight final amount

This provides full transparency into how balances are calculated.
  </action>
  <verify>
- BalanceDetail shows settlements that apply to this balance
- Settlement amounts displayed correctly
- Settlement type badges show
- Total from expenses, total settled, remaining balance calculated correctly
- Fully settled balances show "✓ Fully settled" badge
- Links to settlement details work (if implemented)
  </verify>
  <done>BalanceDetail shows settlement summary. Expenses and settlements both visible. Totals calculated correctly. Full transparency into balance calculation.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] calculateBalances applies settlements correctly
- [ ] Global settlements reduce all balances between pair
- [ ] Tag-specific settlements reduce tag balances only
- [ ] Partial settlements reduce by specified amount
- [ ] Zero balances removed from display
- [ ] useBalances re-calculates when settlements change
- [ ] BalanceView updates immediately after settlement
- [ ] BalanceDetail shows settlement history
- [ ] Test full flow: record settlement, balance updates in UI

**Integration test:**
- [ ] Create expense between two people ($100)
- [ ] Verify balance shows in BalanceView ($100 owed)
- [ ] Record partial settlement ($50)
- [ ] Verify balance updates to $50 owed
- [ ] Record global settlement (remaining $50)
- [ ] Verify balance shows $0 (or disappears from list)
</verification>

<success_criteria>

- calculateBalances integrates settlements into calculation
- All three settlement types (global, tag-specific, partial) applied correctly
- Multi-currency settlements converted properly
- useBalances re-calculates automatically on settlement changes
- BalanceView updates immediately after settlements recorded
- BalanceDetail shows settlement history with totals
- Full expense → settlement → balance flow works end-to-end
- No TypeScript errors or runtime crashes
- Phase 7 complete: settlements fully functional
  </success_criteria>

<output>
After completion, create `.planning/phases/07-settlement-and-payments/07-05-SUMMARY.md`:

# Phase 7 Plan 5: Settlement Integration with Balance Calculation Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/balances/calculator.ts` - Integrated settlement application
- `hooks/useBalances.ts` - Re-calculate on settlement changes
- `components/BalanceDetail.tsx` - Show settlement summary

## Decisions Made

[Key decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase 7 Complete

All 5 plans in Phase 7 complete:
- 07-01: Settlement form foundation ✅
- 07-02: Global settlement ✅
- 07-03: Tag-specific settlement ✅
- 07-04: Settlement history view ✅
- 07-05: Settlement integration ✅

Phase 7 deliverables:
- Record settlements (global, tag-specific, partial)
- Settlements reduce displayed balances
- Settlement history with delete
- Full transparency into balance calculation
- Offline-first settlement recording
- Multi-currency settlement support

Ready for Phase 8: Templates & Efficiency Features
</output>
