---
phase: 07-settlement-and-payments
plan: 01
type: execute
depends_on: []
files_modified: [components/SettlementForm.tsx, lib/actions/settlement.ts]
---

<objective>
Create settlement form component with person selection, amount input, and settlement type selection.

Purpose: Enable users to record when debts are paid back with flexible options (global, tag-specific, partial).
Output: Working settlement form component with validation and offline-first submission.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-balance-calculation-engine/06-01-SUMMARY.md
@lib/db/types.ts
@lib/db/stores.ts
@components/BalanceView.tsx
@hooks/useBalances.ts

**Tech stack available:** Next.js 15, React, TypeScript, Tailwind, Framer Motion, IndexedDB
**Established patterns:**
- Form components with controlled state and validation
- Offline-first with optimistic updates (from Phase 3)
- iOS-native styling with Tailwind classes
- Server actions for async operations (from Phase 4)

**Key context from Phase 6:**
- Balance calculation engine exists (lib/balances/calculator.ts)
- PersonIdentifier type supports hybrid account model (user_id OR participant_id)
- BalanceView shows who owes whom with color coding
- Settlement type in DB schema: 'global' | 'tag_specific' | 'partial'

**Settlement DB schema (already exists):**
```typescript
type Settlement = {
  id: string;
  from_user_id: string | null;
  from_participant_id: string | null;
  to_user_id: string | null;
  to_participant_id: string | null;
  amount: number;
  currency: string;
  settlement_type: 'global' | 'tag_specific' | 'partial';
  tag: string | null;  // Required for tag_specific
  settlement_date: string;
  created_by_user_id: string;
  created_at: string;
}
```

**Settlement CRUD exists:** createSettlement() in lib/db/stores.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettlementForm component with person selection and amount input</name>
  <files>components/SettlementForm.tsx</files>
  <action>
Create SettlementForm component that:
- Accepts optional initialBalance prop (pre-fills from BalanceView)
- Renders "from" and "to" person selectors (use existing participant patterns from ExpenseForm)
- Amount input with currency selector (default to balance currency if pre-filled)
- Settlement date picker (default to today)
- iOS-native styling matching ExpenseForm patterns
- Controlled state for all inputs
- Basic validation: amount > 0, from/to selected, from !== to

Use patterns from ExpenseForm for consistency:
- Same input styling (bg-ios-gray-light, rounded corners)
- Same button patterns (primary action button)
- Same error display (red text below invalid fields)
- Same layout structure (vertical form with spacing)

DO NOT implement submission yet (Task 2). DO NOT implement settlement type selection yet (handled in plans 02-04).
  </action>
  <verify>TypeScript compiles without errors. Component renders with all input fields.</verify>
  <done>SettlementForm component exists with person selectors, amount input, currency selector, and date picker. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement settlement submission with offline-first pattern</name>
  <files>lib/actions/settlement.ts, components/SettlementForm.tsx</files>
  <action>
Create lib/actions/settlement.ts with submitSettlement server action:
- Accepts from/to person identifiers, amount, currency, date, settlement_type
- Validates inputs server-side
- Creates Settlement record using createSettlement() from stores.ts
- Returns { success: true, id } or { success: false, error }
- For now, always use settlement_type: 'partial' (other types in plans 02-03)

Update SettlementForm to:
- Call submitSettlement on form submission
- Show loading state during submission
- Handle success: reset form, show success message, call onSuccess callback if provided
- Handle error: display error message below form
- Use optimistic updates pattern from Phase 3 (lib/offline/optimistic.ts) for immediate UI feedback

Follow patterns from lib/actions/expense.ts for consistency.

DO NOT integrate with balance calculation yet (Plan 05). This is just recording the settlement.
  </action>
  <verify>
Settlement submission works:
- Form submits successfully with valid data
- createSettlement() called with correct parameters
- Form resets after successful submission
- Error messages display for invalid submissions
- TypeScript compiles without errors
  </verify>
  <done>submitSettlement server action exists. Form submits settlements to IndexedDB. Success and error states display correctly. Optimistic updates work.</done>
</task>

<task type="auto">
  <name>Task 3: Add settlement trigger from BalanceView</name>
  <files>components/BalanceView.tsx, components/SettlementForm.tsx</files>
  <action>
Update BalanceView to add "Settle" button on each balance entry:
- Add button next to balance amount (iOS-style pill button, green color)
- Button text: "Settle"
- On click, open SettlementForm in modal/sheet
- Pre-fill form with: from person, to person, amount, currency from balance entry
- Modal/sheet uses existing pattern (check if sheet component exists from Phase 10, if not use simple modal with backdrop)

Update SettlementForm to:
- Accept onSuccess callback prop
- Accept onCancel callback prop
- When embedded in modal, show Cancel and Submit buttons
- On success, call onSuccess and close modal

Use Framer Motion for modal animations (matching existing patterns in app).

DO NOT implement settlement application to balances yet (Plan 05).
  </action>
  <verify>
- "Settle" button appears on balance entries
- Clicking button opens modal with SettlementForm
- Form pre-fills with balance data
- Submitting form closes modal and shows success
- Cancel button closes modal without submitting
  </verify>
  <done>BalanceView has "Settle" buttons. SettlementForm opens in modal with pre-filled data. Submission works and closes modal.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] SettlementForm renders with all required inputs
- [ ] Settlement submission creates Settlement record in IndexedDB
- [ ] BalanceView "Settle" buttons open pre-filled form
- [ ] Form validation works (amount > 0, persons selected)
- [ ] Success/error states display correctly
</verification>

<success_criteria>

- SettlementForm component exists with person/amount/currency/date inputs
- submitSettlement server action creates Settlement records
- BalanceView has "Settle" buttons that open pre-filled form
- Form validation and error handling works
- Modal/sheet animations work smoothly
- No TypeScript errors or runtime crashes
  </success_criteria>

<output>
After completion, create `.planning/phases/07-settlement-and-payments/07-01-SUMMARY.md`:

# Phase 7 Plan 1: Settlement Form Foundation Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `components/SettlementForm.tsx` - Settlement form component
- `lib/actions/settlement.ts` - Settlement submission server action
- `components/BalanceView.tsx` - Added "Settle" buttons

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-02-PLAN.md (Global settlement implementation)
</output>
