---
phase: 07-settlement-and-payments
plan: 04
type: execute
depends_on: []
files_modified: [components/SettlementHistory.tsx, app/settlements/page.tsx, components/BottomNav.tsx]
---

<objective>
Create settlement history view showing all past settlements with details and edit/delete capability.

Purpose: Enable users to view, verify, and manage settlement records for transparency and corrections.
Output: Settlement history screen with list view, detail view, and delete functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-settlement-and-payments/07-01-SUMMARY.md
@lib/db/types.ts
@lib/db/stores.ts
@components/ExpenseList.tsx
@app/expenses/page.tsx

**From Plan 07-01:**
- Settlement records created via submitSettlement
- Settlement type: Settlement in lib/db/types.ts
- getSettlements() exists in lib/db/stores.ts

**Settlement history requirements:**
- List all settlements chronologically (newest first)
- Group by date (Today, Yesterday, This Week, etc.)
- Show settlement type badge (Global, Tag-specific, Partial)
- Show from/to persons, amount, currency
- Tap to view details
- Delete functionality with confirmation
- Filter by person or tag

**NO EDIT capability:** Settlements are immutable for audit purposes. Only delete and re-create if needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettlementHistory component with list view</name>
  <files>components/SettlementHistory.tsx, hooks/useSettlements.ts</files>
  <action>
Create hooks/useSettlements.ts React hook:
- Fetches settlements using getSettlements() from stores
- Returns settlements array and loading state
- Sorts settlements by settlement_date DESC (newest first)
- Re-fetches when settlements change (listen for storage events or use interval)

Create components/SettlementHistory.tsx:
- Uses useSettlements hook to load settlements
- Groups settlements by date:
  - Today
  - Yesterday
  - This Week
  - This Month
  - Older
- Each settlement item shows:
  - Date (if first in group, show group header)
  - From person → To person
  - Amount and currency
  - Settlement type badge (colored pill: green for global, blue for tag-specific, gray for partial)
  - Tag name if tag-specific
  - Tap to expand/show details
- iOS-native list styling (white cards with subtle shadows, chevrons)
- Loading state: skeleton rows
- Empty state: "No settlements yet" with illustration

Follow patterns from ExpenseList.tsx for consistency:
- Same card styling
- Same date grouping logic
- Same loading/empty states
- Same iOS list row styling

DO NOT implement delete yet (Task 2).
  </action>
  <verify>
TypeScript compiles. SettlementHistory renders with settlements grouped by date. Settlement type badges display correctly. Tapping settlement shows details.
  </verify>
  <done>SettlementHistory component exists with grouped list view. useSettlements hook fetches and provides settlements. Loading and empty states work.</done>
</task>

<task type="auto">
  <name>Task 2: Add settlement detail view with delete functionality</name>
  <files>components/SettlementHistory.tsx, lib/db/stores.ts</files>
  <action>
Add deleteSettlement function to lib/db/stores.ts:
- Accepts settlement id
- Deletes Settlement record from IndexedDB
- Returns success boolean
- No soft delete - hard delete for settlements (they can be re-created if needed)

Update SettlementHistory to show detail view:
- Tapping settlement expands to show full details:
  - Settlement type (full text): "Global settlement", "Tag-specific settlement for #bali-trip", "Partial payment"
  - From person (full name)
  - To person (full name)
  - Amount and currency (large, prominent)
  - Date (full date format: "January 5, 2026")
  - Created timestamp (small, gray text)
- Delete button at bottom of detail view:
  - Red destructive style (iOS pattern)
  - Text: "Delete Settlement"
  - Tapping shows confirmation alert:
    - Title: "Delete Settlement?"
    - Message: "This will remove this {amount} settlement. This cannot be undone."
    - Actions: "Cancel" (default), "Delete" (destructive)
  - On confirm, calls deleteSettlement()
  - Shows success message and removes from list
  - On error, shows error message

Detail view animations:
- Expand/collapse with smooth height animation (Framer Motion)
- Delete button fade in when expanded
- Removed item fades out

iOS-native styling:
- Expanded card shows more details without leaving page
- Delete button matches iOS destructive button style
- Confirmation alert uses native-like styling
  </action>
  <verify>
- Tapping settlement expands to show details
- Delete button appears in expanded view
- Delete confirmation alert shows
- Confirming delete removes settlement from IndexedDB
- Removed settlement disappears from list with animation
- Canceling delete keeps settlement
  </verify>
  <done>Settlement detail view expands on tap. Delete button with confirmation works. deleteSettlement removes record. Animations smooth.</done>
</task>

<task type="auto">
  <name>Task 3: Create settlements page and add to navigation</name>
  <files>app/settlements/page.tsx, components/BottomNav.tsx</files>
  <action>
Create app/settlements/page.tsx:
- Page title: "Settlements"
- Renders SettlementHistory component
- Same page structure as app/expenses/page.tsx (header, content area, safe area padding)
- No FAB (settlements created from BalanceView, not standalone)

Update components/BottomNav.tsx to add Settlements tab:
- Update tabs array to include:
  - Expenses (existing)
  - Balances (existing)
  - Settlements (new)
  - Profile (existing)
- Icon for Settlements: receipt or check mark icon
- Route: /settlements
- Active state styling matches other tabs

Tab order: Expenses → Balances → Settlements → Profile

iOS-native styling:
- Bottom tab bar remains fixed
- Safe area padding for tab bar
- Active tab has blue accent color
- Inactive tabs gray
- Smooth tab transitions (Framer Motion)

DO NOT add filtering yet (could be future enhancement).
  </action>
  <verify>
- /settlements page exists and renders SettlementHistory
- Settlements tab appears in bottom navigation
- Tapping tab navigates to settlements page
- Active state styling works
- Page layout matches Expenses and Balances pages
- Safe area padding correct on iOS
  </verify>
  <done>/settlements page exists. SettlementHistory renders on page. Settlements tab added to bottom nav. Navigation works. Styling matches app patterns.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] useSettlements hook fetches settlements correctly
- [ ] SettlementHistory groups settlements by date
- [ ] Settlement type badges display correctly
- [ ] Delete functionality works with confirmation
- [ ] /settlements page renders correctly
- [ ] Settlements tab in bottom nav works
- [ ] Safe area padding correct on iOS devices
</verification>

<success_criteria>

- SettlementHistory component displays settlements grouped by date
- Settlement type badges show correct colors and text
- Detail view expands with full settlement information
- Delete with confirmation removes settlements
- /settlements page exists and accessible via bottom nav
- Navigation between tabs smooth with animations
- No TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/07-settlement-and-payments/07-04-SUMMARY.md`:

# Phase 7 Plan 4: Settlement History View Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `components/SettlementHistory.tsx` - Settlement list and detail view
- `hooks/useSettlements.ts` - Settlement data fetching hook
- `app/settlements/page.tsx` - Settlements page
- `components/BottomNav.tsx` - Added Settlements tab
- `lib/db/stores.ts` - Added deleteSettlement

## Decisions Made

[Key decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-05-PLAN.md (Apply settlements to balance calculation)
</output>
