---
phase: 07-settlement-and-payments
plan: 03
type: execute
depends_on: ["07-01"]
files_modified: [components/SettlementForm.tsx, components/TagFilter.tsx]
---

<objective>
Implement tag-specific settlement functionality that settles balances for a specific tag context (e.g., just #bali-trip).

Purpose: Enable users to settle debts for a specific trip/event while keeping other balances outstanding.
Output: Tag selector in SettlementForm for tag-specific settlements with balance calculation per tag.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-settlement-and-payments/07-01-SUMMARY.md
@.planning/phases/05-tagging-and-organization/05-01-SUMMARY.md
@components/SettlementForm.tsx
@components/TagInput.tsx
@lib/db/types.ts
@lib/balances/calculator.ts

**From Plan 07-01:**
- SettlementForm exists with person/amount/currency/date inputs
- submitSettlement server action exists

**From Phase 5:**
- Tag system exists
- TagInput component exists (autocomplete tag input)
- Expenses have tags via ExpenseTag records

**Tag-specific settlement requirements:**
- Calculate balance between two people for ONLY expenses with specific tag
- Record settlement with settlement_type: 'tag_specific', tag: '{tag_name}'
- Tag selector shows only tags that have balances between the two selected people
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calculateTagBalance helper for tag-specific balance calculation</name>
  <files>lib/balances/calculator.ts</files>
  <action>
Add calculateTagBalance function to lib/balances/calculator.ts:
- Accepts two PersonIdentifiers and a tag name
- Fetches all expenses that have the specified tag (join with ExpenseTag table)
- Calculates balances ONLY for those tagged expenses
- Returns net amount between the two people for that tag context
- Returns { amount: number, currency: string, direction: 'A_owes_B' | 'B_owes_A' | 'settled' }
- Handles multi-currency by converting to primary currency

Also add getTagsWithBalances function:
- Accepts two PersonIdentifiers
- Returns list of tags that have balances between these two people
- Used to populate tag selector in SettlementForm
- Returns array of { tag: string, balance: number, currency: string }

Export both functions for use in components.
  </action>
  <verify>
TypeScript compiles. calculateTagBalance returns correct balance for specific tag. getTagsWithBalances returns all tags with balances between two people.
  </verify>
  <done>calculateTagBalance and getTagsWithBalances functions exist and correctly compute tag-specific balances.</done>
</task>

<task type="auto">
  <name>Task 2: Add tag-specific settlement option to SettlementForm</name>
  <files>components/SettlementForm.tsx</files>
  <action>
Update SettlementForm to support tag-specific settlements:
- Update settlement type selector to three options:
  - "Settle All" (Plan 02, settlement_type: 'global')
  - "Settle Tag" (new, settlement_type: 'tag_specific')
  - "Partial Amount" (existing, settlement_type: 'partial')
- When "Settle Tag" selected:
  - Show tag selector dropdown
  - Call getTagsWithBalances(from, to) to get tags with balances
  - Display each tag with its balance: "#bali-trip: $250 owed"
  - When tag selected, call calculateTagBalance(from, to, tag)
  - Auto-fill amount with tag balance (make readonly)
  - Auto-fill currency with tag balance currency (make readonly)
  - Show info message: "This will settle balances for #{tag}"
- Update submission to pass:
  - settlement_type: 'tag_specific'
  - tag: selected tag name
  - amount: tag balance
  - currency: tag balance currency

Handle case where no tags have balances:
- If getTagsWithBalances returns empty array, show message: "No tagged expenses between these people"
- Disable "Settle Tag" option if no tags available

iOS-native styling:
- Tag selector as dropdown menu (iOS pattern)
- Each tag option shows tag name and balance amount
- Selected tag highlighted with checkmark
- Readonly fields have gray background
  </action>
  <verify>
- "Settle Tag" option appears in settlement type selector
- Tag dropdown shows only tags with balances between selected people
- Selecting tag calculates and displays tag-specific balance
- Amount/currency auto-fill and become readonly
- Submitting passes settlement_type: 'tag_specific' and tag name
- Empty tag list handled gracefully
  </verify>
  <done>SettlementForm supports tag-specific settlements. Tag selector shows tags with balances. Tag balance auto-calculated and amount readonly. settlement_type: 'tag_specific' and tag passed on submission.</done>
</task>

<task type="auto">
  <name>Task 3: Add tag filter to BalanceView with tag-specific settle buttons</name>
  <files>components/BalanceView.tsx</files>
  <action>
Update BalanceView to support tag-based balance filtering:
- Add tag filter dropdown above balance list (similar to currency selector)
- Options: "All Tags" (default), then list of all tags from expenses
- When tag selected, filter balances to show ONLY balances for that tag context
- Balance calculation should use calculateTagBalance for filtered view
- When tag filter active:
  - Show badge indicating active filter: "Filtered by #bali-trip"
  - Show "Clear filter" button to return to all balances
  - Settlement buttons open form with "Settle Tag" pre-selected for that tag

Settlement button behavior when tag filtered:
- "Settle All" button â†’ opens form with "Settle Tag" pre-selected (not "Settle All")
- Pre-fills with filtered tag
- Amount auto-calculated for that tag context

Settlement button behavior when "All Tags" (no filter):
- Existing behavior from Plan 02 (global settlement)

Tag filter persists in component state (not URL params for now).

iOS-native styling:
- Tag filter dropdown matches currency selector styling
- Filter badge with dismiss X button
- Smooth transitions when filter applied/removed
  </action>
  <verify>
- Tag filter dropdown appears above balance list
- Selecting tag filters balances to that tag context
- Filtered view shows only tag-specific balances
- "Settle All" button opens form with tag pre-selected when filtered
- Clear filter button returns to all balances
- Tag filter dropdown lists all tags from expenses
  </verify>
  <done>BalanceView has tag filter. Filtered view shows tag-specific balances. Settlement buttons adapt to filtered context. Clear filter works.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] calculateTagBalance returns correct balance for specific tag
- [ ] getTagsWithBalances returns all tags with balances
- [ ] "Settle Tag" option works in SettlementForm
- [ ] Tag selector shows only relevant tags
- [ ] Tag-specific settlements record with correct settlement_type and tag
- [ ] BalanceView tag filter filters balances correctly
- [ ] Settlement buttons adapt to filtered context
</verification>

<success_criteria>

- calculateTagBalance and getTagsWithBalances functions work correctly
- SettlementForm has "Settle Tag" option with tag selector
- Tag-specific balance auto-calculated and amount readonly
- Tag-specific settlements record with settlement_type: 'tag_specific'
- BalanceView has tag filter dropdown
- Filtered view shows tag-specific balances
- Settlement buttons adapt to tag filter context
- No TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/07-settlement-and-payments/07-03-SUMMARY.md`:

# Phase 7 Plan 3: Tag-Specific Settlement Implementation Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/balances/calculator.ts` - Added calculateTagBalance, getTagsWithBalances
- `components/SettlementForm.tsx` - Added "Settle Tag" option
- `components/BalanceView.tsx` - Added tag filter

## Decisions Made

[Key decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-04-PLAN.md (Settlement history view)
</output>
