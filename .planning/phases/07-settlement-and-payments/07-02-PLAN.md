---
phase: 07-settlement-and-payments
plan: 02
type: execute
depends_on: ["07-01"]
files_modified: [components/SettlementForm.tsx, lib/balances/calculator.ts]
---

<objective>
Implement global settlement functionality that zeros out all balances between two people with a single transaction.

Purpose: Enable users to settle all debts with someone at once, the most common settlement scenario.
Output: "Settle All" option in SettlementForm that calculates total debt and records global settlement.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-settlement-and-payments/07-01-SUMMARY.md
@lib/balances/calculator.ts
@lib/balances/types.ts
@components/SettlementForm.tsx
@lib/db/types.ts

**From Plan 07-01:**
- SettlementForm exists with person/amount/currency/date inputs
- submitSettlement server action creates Settlement records
- Currently uses settlement_type: 'partial'

**Global settlement requirements:**
- Zero out ALL balances between two people (across all tags, all expenses)
- Calculate net balance: sum all debts in both directions
- Record single settlement for net amount
- Use settlement_type: 'global', tag: null
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calculateNetBalance helper for global settlements</name>
  <files>lib/balances/calculator.ts</files>
  <action>
Add calculateNetBalance function to lib/balances/calculator.ts:
- Accepts two PersonIdentifiers (person A, person B)
- Fetches all balances using existing calculateBalances()
- Sums all debts where A owes B
- Sums all debts where B owes A
- Returns net amount: { amount: number, currency: string, direction: 'A_owes_B' | 'B_owes_A' | 'settled' }
- If multiple currencies, convert to primary currency (most-used currency) using existing exchange rate logic
- Returns 'settled' if net amount is 0

This provides the data needed for "Settle All" button to show what the global settlement would be.

Export this function for use in components.
  </action>
  <verify>
TypeScript compiles. calculateNetBalance returns correct net balance for two people. Multi-currency balances converted to single currency correctly.
  </verify>
  <done>calculateNetBalance function exists and correctly computes net balances between two people across all expenses.</done>
</task>

<task type="auto">
  <name>Task 2: Add "Settlement Type" selector to SettlementForm</name>
  <files>components/SettlementForm.tsx</files>
  <action>
Update SettlementForm to add settlement type selection:
- Add radio buttons or segmented control: "Settle All" vs "Partial Amount"
- Default to "Partial Amount" (current behavior)
- When "Settle All" selected:
  - Call calculateNetBalance(from, to) to get net amount
  - Display calculated net balance prominently: "Net balance: {person} owes {person} {amount}"
  - Auto-fill amount field with net balance (make readonly when "Settle All" selected)
  - Auto-fill currency with net balance currency (make readonly)
  - Show info message: "This will settle all balances between these people"
- When "Partial Amount" selected:
  - Amount and currency fields editable (current behavior)
- Update submission to pass settlement_type: 'global' when "Settle All" selected

iOS-native styling:
- Use segmented control pattern (iOS standard for binary choice)
- Calculate net balance button style similar to currency selector
- Readonly fields have gray background to indicate non-editable

DO NOT implement settlement application to balance calculation yet (Plan 05).
  </action>
  <verify>
- "Settle All" option displays in form
- Selecting "Settle All" calculates and displays net balance
- Amount/currency fields auto-fill and become readonly
- Submitting "Settle All" passes settlement_type: 'global'
- Selecting "Partial Amount" restores editable fields
  </verify>
  <done>SettlementForm has settlement type selector. "Settle All" auto-calculates net balance and makes amount readonly. settlement_type: 'global' passed on submission.</done>
</task>

<task type="auto">
  <name>Task 3: Add "Settle All" quick action to BalanceView</name>
  <files>components/BalanceView.tsx</files>
  <action>
Update BalanceView to add "Settle All" button alongside existing "Settle" button:
- Two buttons per balance entry:
  - "Settle" (existing) - opens form with partial amount pre-filled
  - "Settle All" (new) - opens form with "Settle All" type pre-selected and net balance calculated
- "Settle All" button:
  - Primary style (more prominent)
  - Green color
  - Opens SettlementForm with:
    - from/to pre-filled
    - settlementType: 'global' pre-selected
    - Net balance auto-calculated and displayed
- "Settle" button:
  - Secondary style (less prominent)
  - Gray/neutral color
  - Opens SettlementForm with:
    - from/to pre-filled
    - settlementType: 'partial' pre-selected (current behavior)
    - Amount editable

Button layout:
- Horizontal button group (iOS pattern)
- "Settle All" on left (primary action)
- "Settle" on right (secondary action)
- Proper spacing and touch targets (44px minimum height)

Only show "Settle All" if net balance exists (not for $0 balances).
  </action>
  <verify>
- Both "Settle All" and "Settle" buttons appear on balance entries
- "Settle All" opens form with global settlement pre-selected
- "Settle" opens form with partial settlement pre-selected
- Button styling matches iOS patterns (primary/secondary)
- Touch targets are adequate for mobile
  </verify>
  <done>BalanceView has "Settle All" and "Settle" buttons. Each opens form with appropriate pre-selected settlement type. Styling matches iOS conventions.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] calculateNetBalance correctly sums balances between two people
- [ ] "Settle All" option in form auto-calculates net balance
- [ ] Net balance calculation handles multi-currency correctly
- [ ] Amount field becomes readonly when "Settle All" selected
- [ ] "Settle All" button appears on BalanceView entries
- [ ] Global settlements record with settlement_type: 'global'
</verification>

<success_criteria>

- calculateNetBalance function computes net debts correctly
- SettlementForm has "Settle All" vs "Partial Amount" selector
- "Settle All" auto-fills amount with net balance
- BalanceView has both "Settle All" and "Settle" buttons
- Global settlements record with correct settlement_type
- Multi-currency net balances calculated correctly
- No TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/07-settlement-and-payments/07-02-SUMMARY.md`:

# Phase 7 Plan 2: Global Settlement Implementation Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/balances/calculator.ts` - Added calculateNetBalance
- `components/SettlementForm.tsx` - Added settlement type selector
- `components/BalanceView.tsx` - Added "Settle All" buttons

## Decisions Made

[Key decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 07-03-PLAN.md (Tag-specific settlement implementation)
</output>
