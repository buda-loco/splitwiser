---
phase: 06-balance-calculation-engine
plan: 05
type: execute
depends_on: ["06-01", "06-04"]
files_modified: [lib/balances/calculator.ts, components/BalanceView.tsx]
---

<objective>
Implement multi-currency balance view toggle allowing users to see all balances converted to their preferred currency.

Purpose: Users track expenses in multiple currencies during travel. Need unified view in single currency.
Output: Currency selector in balance view that converts all balances to chosen currency using real-time rates.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase
@.planning/phases/06-balance-calculation-engine/06-01-SUMMARY.md
@.planning/phases/06-balance-calculation-engine/06-03-SUMMARY.md
@.planning/phases/06-balance-calculation-engine/06-04-SUMMARY.md

# Key files
@lib/balances/calculator.ts
@lib/currency/exchangeRates.ts
@components/BalanceView.tsx

**Established patterns:**
- Optional parameters for feature toggles (simplified in plan 06-02)
- Currency selection UI (from ExpenseForm 04-01)
- State management in hooks with useEffect dependencies

**Constraining decisions:**
- User has currency_preference in profile (from types.ts)
- Supported currencies: AUD, USD, EUR, GBP (from plan 06-04)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add currency conversion to balance calculator</name>
  <files>lib/balances/calculator.ts</files>
  <action>
Update calculateBalances to support target currency:

```typescript
export async function calculateBalances(options?: {
  simplified?: boolean;
  targetCurrency?: CurrencyCode;
}): Promise<BalanceResult> {
  // ... existing direct balance calculation ...

  let balances = options?.simplified
    ? simplifyDebts(directBalances)
    : directBalances;

  // Convert to target currency if specified
  if (options?.targetCurrency) {
    balances = await convertBalances(balances, options.targetCurrency);
  }

  return {
    balances,
    total_expenses: /* existing */,
    currency: options?.targetCurrency || /* detect from expenses */,
  };
}
```

Why convert after simplification: Conversion is display-only. Simplification algorithm works on original amounts.

Currency detection when no target specified: Use most common currency from expenses (mode of expense currencies).
  </action>
  <verify>Function compiles. Test with targetCurrency option, verify all balances converted to target.</verify>
  <done>calculateBalances() supports targetCurrency option. Converts all balances to specified currency using exchange rates.</done>
</task>

<task type="auto">
  <name>Task 2: Add currency selector to useBalances hook</name>
  <files>hooks/useBalances.ts</files>
  <action>
Add currency selection state:

```typescript
export function useBalances() {
  const [balances, setBalances] = useState<BalanceResult | null>(null);
  const [loading, setLoading] = useState(true);
  const [simplified, setSimplified] = useState(false);
  const [targetCurrency, setTargetCurrency] = useState<CurrencyCode>('AUD');  // Default to AUD

  useEffect(() => {
    async function loadBalances() {
      const result = await calculateBalances({
        simplified,
        targetCurrency,
      });
      setBalances(result);
      setLoading(false);
    }

    setLoading(true);
    loadBalances();
  }, [simplified, targetCurrency]);  // Recalculate when either changes

  return {
    balances,
    loading,
    simplified,
    setSimplified,
    targetCurrency,
    setTargetCurrency,
  };
}
```

Why default to AUD: PROJECT.md mentions AUD as example currency. In future, could load from user profile's currency_preference.

Dependency array includes targetCurrency: Changing currency triggers recalculation with new conversion.
  </action>
  <verify>Hook compiles. Changing targetCurrency triggers balance recalculation with currency conversion.</verify>
  <done>useBalances hook supports targetCurrency state. Exposes setTargetCurrency for UI control.</done>
</task>

<task type="auto">
  <name>Task 3: Add currency selector UI to BalanceView</name>
  <files>components/BalanceView.tsx</files>
  <action>
Add currency selector dropdown to BalanceView component:

Location: Next to simplified toggle at top of view.

UI structure:
```jsx
<div className="flex justify-between items-center mb-4">
  {/* Left: Simplified toggle (existing) */}
  <div>...</div>

  {/* Right: Currency selector */}
  <select
    value={targetCurrency}
    onChange={(e) => setTargetCurrency(e.target.value as CurrencyCode)}
    className="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 ..."
  >
    <option value="AUD">AUD</option>
    <option value="USD">USD</option>
    <option value="EUR">EUR</option>
    <option value="GBP">GBP</option>
  </select>
</div>
```

Styling:
- Match ExpenseForm currency select styling
- iOS-native appearance
- Compact size (this is a utility control, not primary action)

Label (optional): "Currency:" prefix or currency symbol ($ € £ AU$)

Get targetCurrency and setTargetCurrency from useBalances hook.

Why separate from simplified toggle: Two independent dimensions (simplification algorithm vs display currency).
  </action>
  <verify>Component compiles. Currency selector appears. Changing currency updates all balance amounts.</verify>
  <done>Currency selector in BalanceView allows switching display currency. All balances re-rendered with new currency.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] calculateBalances() supports targetCurrency option
- [ ] useBalances hook provides targetCurrency state
- [ ] Currency selector UI works
- [ ] Changing currency converts all balances
- [ ] Loading state shown during recalculation
- [ ] Both simplified toggle and currency selector work independently
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Multi-currency balance view functional
- Currency conversion accurate (uses rates from plan 06-04)
- UI intuitive with currency selector
- Works alongside simplified/direct toggle
</success_criteria>

<output>
After completion, create `.planning/phases/06-balance-calculation-engine/06-05-SUMMARY.md`
</output>
