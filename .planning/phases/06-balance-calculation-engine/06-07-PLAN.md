---
phase: 06-balance-calculation-engine
plan: 07
type: execute
depends_on: ["06-03", "06-05"]
files_modified: [components/BalanceView.tsx, components/BalanceDetail.tsx]
---

<objective>
Enhance balance summary screen with detailed breakdowns showing which expenses contribute to each balance.

Purpose: Users want transparency - not just "A owes B $50" but "from which expenses?". Builds trust in calculations.
Output: Expandable balance entries that show expense-level detail when clicked.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work in this phase
@.planning/phases/06-balance-calculation-engine/06-03-SUMMARY.md
@.planning/phases/06-balance-calculation-engine/06-05-SUMMARY.md

# Key files
@components/BalanceView.tsx
@lib/balances/calculator.ts

**Established patterns:**
- Expandable list items (similar to expense detail views)
- Framer Motion for expand/collapse animations
- iOS-native sheet modals for details
- Expense list items with tags and amounts

**User requirement (from PROJECT.md):**
- "Complete version history per expense (who created, who edited, what changed, when)"
- "Transparent audit trail: Every edit versioned, nobody can silently delete expenses"
- Trust and transparency are core values
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expense tracking to balance calculator</name>
  <files>lib/balances/calculator.ts, lib/balances/types.ts</files>
  <action>
Update BalanceEntry type to include contributing expenses:

```typescript
export type BalanceEntry = {
  from: PersonIdentifier;
  to: PersonIdentifier;
  amount: number;
  currency: string;
  expenses?: {
    id: string;
    description: string;
    amount: number;
    date: string;
    split_amount: number;  // How much this person owes for this expense
  }[];
};
```

Update calculateBalances to track expenses:
- While aggregating debts, keep list of which expenses contributed
- Each expense that creates a debt from A to B gets added to that BalanceEntry's expenses array
- If simplified=true, expenses may not map cleanly (simplification merges debts), so only include in direct view

Why track expenses:
- User clicks balance → sees which expenses created this debt
- Provides audit trail and transparency
- Enables future "dispute this balance" feature

Only populate expenses for direct view (simplified=false):
- Simplified view aggregates across person pairs, losing expense-level detail
- Direct view shows actual expense relationships, preserving detail
  </action>
  <verify>Type compiles. calculateBalances with simplified=false includes expenses array in each BalanceEntry.</verify>
  <done>BalanceEntry includes expenses array showing contributing expenses. Populated in direct view only.</done>
</task>

<task type="auto">
  <name>Task 2: Create BalanceDetail component</name>
  <files>components/BalanceDetail.tsx</files>
  <action>
Create component showing expense breakdown for a balance entry:

Props:
```typescript
type BalanceDetailProps = {
  balance: BalanceEntry;
  isOpen: boolean;
  onClose: () => void;
};
```

Structure:
1. Header: "{from.name} owes {to.name} {currency}{amount}"
2. Subtitle: "From {expenses.length} expense(s)"
3. Expense list:
   - Each expense: description, date, total amount, split amount
   - Example: "Dinner at Restaurant - Jan 15 - Total: $150 - Your share: $50"
4. Total at bottom: Sum of all split_amounts (should equal balance.amount)

Styling:
- iOS-native sheet modal (Framer Motion slide up from bottom)
- List rows for each expense (similar to ExpenseList items)
- Tap expense row → navigate to /expenses/{id} (expense detail)
- Close button or swipe-down-to-dismiss

Empty state (simplified view):
- "Expense breakdown only available in direct view"
- Prompt user to toggle off simplified mode

Pattern: Follow existing sheet modal patterns from app. Drag-to-dismiss with Framer Motion.
  </action>
  <verify>Component compiles. Shows expense list for balance entry. Navigates to expense detail on tap.</verify>
  <done>BalanceDetail component displays contributing expenses for a balance. iOS sheet modal with expense list and navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Add expand/collapse to BalanceView balance entries</name>
  <files>components/BalanceView.tsx</files>
  <action>
Make balance entries tappable to show detail:

State:
```typescript
const [selectedBalance, setSelectedBalance] = useState<BalanceEntry | null>(null);
```

Balance entry onClick:
```typescript
<div
  className="... cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"
  onClick={() => setSelectedBalance(balance)}
>
  {/* existing balance entry content */}
  {/* Add chevron icon on right to indicate tappable */}
  <ChevronRightIcon className="w-5 h-5 text-gray-400" />
</div>
```

Render BalanceDetail modal:
```jsx
{selectedBalance && (
  <BalanceDetail
    balance={selectedBalance}
    isOpen={true}
    onClose={() => setSelectedBalance(null)}
  />
)}
```

Visual indicator:
- Chevron icon (›) on right of each balance entry
- Subtle hover effect (bg color change)
- iOS-style list row interaction

Only enable if expenses available:
- If simplified=true, show disabled state or info icon
- Tooltip: "Switch to direct view to see expense breakdown"
  </action>
  <verify>Component compiles. Tapping balance entry opens detail modal. Modal shows expense list. Closing modal works.</verify>
  <done>Balance entries tappable. Opens BalanceDetail modal showing contributing expenses. Disabled/info state for simplified view.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] BalanceEntry includes expenses array
- [ ] expenses populated in direct view only
- [ ] BalanceDetail component shows expense list
- [ ] Tapping balance entry opens detail modal
- [ ] Tapping expense in detail navigates to expense detail page
- [ ] Modal dismisses correctly
- [ ] Simplified view shows appropriate message (no breakdown)
- [ ] Dark mode works throughout
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Balance entries expandable to see contributing expenses
- Transparent audit trail for all balances
- iOS-native interaction patterns
- Graceful handling of simplified view (no expense mapping)
</success_criteria>

<output>
After completion, create `.planning/phases/06-balance-calculation-engine/06-07-SUMMARY.md`
</output>
