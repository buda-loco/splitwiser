---
phase: 06-balance-calculation-engine
plan: 08
type: execute
depends_on: []
files_modified: [lib/currency/geolocation.ts, components/ExpenseForm.tsx]
---

<objective>
Implement currency auto-detection based on user's location for faster expense entry while traveling.

Purpose: Users traveling internationally shouldn't manually switch currency for every expense. Auto-detect based on location.
Output: Currency field auto-populates based on geolocation, with manual override always available.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files
@components/ExpenseForm.tsx
@lib/currency/types.ts

**User stories:**
- User in Paris adds expense ‚Üí currency auto-detects to EUR
- User boards flight from France to UK ‚Üí next expense auto-detects GBP
- User can always override auto-detection (visiting EUR country but wants to track in USD)

**Privacy & permissions:**
- Geolocation requires user permission
- Must handle permission denial gracefully
- No geolocation ‚Üí fall back to user's currency_preference
- Geolocation is best-effort enhancement, never required

**Browser Geolocation API:**
- `navigator.geolocation.getCurrentPosition()`
- Returns { latitude, longitude }
- Requires HTTPS (PWA requirement already met)
- User must approve permission prompt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geolocation-to-currency mapping</name>
  <files>lib/currency/geolocation.ts</files>
  <action>
Create function to determine currency from coordinates:

Approach:
- Use country bounding boxes for supported currencies
- Simple lat/lon range checks (no external API needed)

```typescript
type CurrencyRegion = {
  currency: CurrencyCode;
  bounds: {
    north: number;
    south: number;
    east: number;
    west: number;
  };
  countries: string[];  // For reference/debugging
};

const CURRENCY_REGIONS: CurrencyRegion[] = [
  {
    currency: 'EUR',
    bounds: { north: 71, south: 36, east: 40, west: -10 },
    countries: ['Eurozone countries'],
  },
  {
    currency: 'GBP',
    bounds: { north: 61, south: 49, east: 2, west: -8 },
    countries: ['United Kingdom'],
  },
  {
    currency: 'USD',
    bounds: { north: 72, south: 24, east: -66, west: -125 },
    countries: ['United States'],
  },
  {
    currency: 'AUD',
    bounds: { north: -10, south: -44, east: 154, west: 113 },
    countries: ['Australia'],
  },
  // Add more as needed
];

export function getCurrencyFromCoordinates(lat: number, lon: number): CurrencyCode | null {
  for (const region of CURRENCY_REGIONS) {
    if (
      lat >= region.bounds.south &&
      lat <= region.bounds.north &&
      lon >= region.bounds.west &&
      lon <= region.bounds.east
    ) {
      return region.currency;
    }
  }
  return null;  // No match found
}
```

Why bounding boxes instead of API:
- No external dependency (works offline)
- No API costs
- Fast (simple math)
- Sufficient accuracy for 4 major currency zones
- Can expand with more regions as needed

Limitations:
- Crude for small countries or border regions
- Eurozone countries share EUR but have different bounds (use largest bounding box)
- For v1, simple approach is acceptable

Future enhancement: Use reverse geocoding API for precise country detection, but adds dependency.
  </action>
  <verify>Function compiles. Test with coordinates from Sydney (AUD), London (GBP), Paris (EUR), New York (USD).</verify>
  <done>getCurrencyFromCoordinates() maps lat/lon to currency using bounding boxes. No external API required.</done>
</task>

<task type="auto">
  <name>Task 2: Implement geolocation permission handling</name>
  <files>lib/currency/geolocation.ts</files>
  <action>
Create wrapper for browser geolocation with permission handling:

```typescript
export async function detectCurrencyFromLocation(): Promise<CurrencyCode | null> {
  // Check if geolocation available
  if (!navigator.geolocation) {
    console.log('Geolocation not supported');
    return null;
  }

  try {
    const position = await new Promise<GeolocationPosition>((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        resolve,
        reject,
        {
          timeout: 5000,  // 5 second timeout
          maximumAge: 3600000,  // Accept 1-hour cached position
          enableHighAccuracy: false,  // Battery-friendly
        }
      );
    });

    const currency = getCurrencyFromCoordinates(
      position.coords.latitude,
      position.coords.longitude
    );

    if (currency) {
      console.log(`Detected currency: ${currency} (${position.coords.latitude}, ${position.coords.longitude})`);
    }

    return currency;
  } catch (error) {
    // Permission denied, timeout, or other error
    console.log('Could not detect location:', error);
    return null;
  }
}
```

Error handling:
- Permission denied ‚Üí return null (user explicitly declined)
- Timeout ‚Üí return null (taking too long)
- Position unavailable ‚Üí return null (no GPS signal)
- Null result ‚Üí form falls back to user's currency_preference

Why 1-hour cached position: User doesn't move countries every minute. Recent position is fine.

Why low accuracy: Don't need precise coordinates, just general region. Saves battery.

Privacy: User must approve permission. No silent tracking. Position never stored or sent to server.
  </action>
  <verify>Function compiles. Test permission prompt, test permission denial (returns null), test successful detection.</verify>
  <done>detectCurrencyFromLocation() handles geolocation permission, timeout, and error cases. Returns null on any failure.</done>
</task>

<task type="auto">
  <name>Task 3: Auto-detect currency in ExpenseForm</name>
  <files>components/ExpenseForm.tsx</files>
  <action>
Add currency auto-detection on form mount:

```typescript
const [currency, setCurrency] = useState<CurrencyCode>('AUD');  // Default
const [currencyAutoDetected, setCurrencyAutoDetected] = useState(false);

useEffect(() => {
  async function autoDetectCurrency() {
    const detected = await detectCurrencyFromLocation();

    if (detected) {
      setCurrency(detected);
      setCurrencyAutoDetected(true);
    } else {
      // Fall back to user's currency preference
      // TODO: Load from user profile in future
      setCurrency('AUD');
    }
  }

  autoDetectCurrency();
}, []);  // Run once on mount
```

UI feedback:
- Show subtle indicator when auto-detected: "üìç Auto-detected: EUR"
- User can still override manually via dropdown
- Indicator disappears after user manually changes currency

Pattern:
- Auto-detection is enhancement, not requirement
- Always allow manual override
- Fail gracefully with sensible default

Permission prompt timing:
- Triggered on first expense creation
- User sees "Allow location access?" prompt
- If denied, never ask again (respect user choice)
- Future expense forms skip detection (permission already denied)

Alternative approach (don't implement yet): Ask for permission explicitly with explanation before calling geolocation. Could add "Enable auto-detection" toggle in settings. For v1, implicit permission prompt is acceptable.
  </action>
  <verify>Form compiles. Currency auto-detects on mount (if permission granted). Manual override works. Graceful fallback if permission denied.</verify>
  <done>ExpenseForm auto-detects currency from location on mount. Shows indicator, allows override, fails gracefully.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] getCurrencyFromCoordinates() maps coordinates to currencies
- [ ] detectCurrencyFromLocation() handles permissions and errors
- [ ] ExpenseForm auto-detects currency on mount
- [ ] Permission denial handled gracefully (no crashes)
- [ ] Manual override always works
- [ ] Fallback to default currency if no detection
- [ ] Auto-detection indicator shown in UI
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Currency auto-detection functional
- Permission handling graceful
- Privacy-respecting (user approval required)
- Manual override always available
- Enhances UX without being required
</success_criteria>

<output>
After completion, create `.planning/phases/06-balance-calculation-engine/06-08-SUMMARY.md`

## Phase 6 Complete

This is the final plan for Phase 6: Balance Calculation Engine. All 8 plans defined:
- 06-01: Core balance calculation
- 06-02: Debt simplification algorithm
- 06-03: Balance summary screen UI
- 06-04: Currency exchange rate API integration
- 06-05: Multi-currency balance view
- 06-06: Manual exchange rate override
- 06-07: Balance detail with expense breakdown
- 06-08: Currency auto-detection from location

Phase covers:
- Global balance calculations (tag-independent)
- Debt simplification toggle
- Multi-currency support with real-time rates
- Manual rate override for accuracy
- Transparent expense breakdown
- Location-based currency detection

Ready for `/gsd:execute-phase 6` (parallel execution of independent plans).
</output>
