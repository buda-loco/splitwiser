---
phase: 02-authentication-and-user-model
plan: 01
type: execute
depends_on: []
files_modified: [lib/supabase/middleware.ts, middleware.ts, app/auth/login/page.tsx, app/auth/callback/route.ts]
---

<objective>
Setup Supabase Auth with email magic links for passwordless authentication.

Purpose: Establish secure, low-friction authentication using Supabase's built-in magic link flow. No passwords to manage, better security, and simpler UX.
Output: Working magic link authentication with login page, callback handling, and session management via middleware.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-setup/01-02-SUMMARY.md

**Tech stack available:** @supabase/ssr@0.8.0, @supabase/supabase-js@2.95.0, Next.js 15, TypeScript
**Established patterns:** SSR-safe auth, cookie-session, client-server-separation
**Key files:** lib/supabase/client.ts, lib/supabase/server.ts, lib/supabase/middleware.ts

**Constraining decisions:**
- Phase 1: Supabase SSR client with cookie-based sessions
- PROJECT.md: Hybrid account model (users can claim accounts later)
- PROJECT.md: Generous free tier, no aggressive monetization
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for auth token refresh</name>
  <files>middleware.ts</files>
  <action>Create Next.js middleware that calls updateSession from lib/supabase/middleware.ts on every request. This refreshes auth tokens automatically and ensures sessions stay valid. Use matcher config to run on all routes except _next/static, _next/image, favicon.ico. Import { NextResponse } from 'next/server' and { updateSession } from '@/lib/supabase/middleware'. Call updateSession(request) and return the result.</action>
  <verify>File exists at root with correct matcher config excluding static assets</verify>
  <done>Middleware exports default async function, calls updateSession, has proper matcher</done>
</task>

<task type="auto">
  <name>Task 2: Create magic link login page</name>
  <files>app/auth/login/page.tsx</files>
  <action>Create login page with email input and submit button. Use 'use client' directive. Import createClient from '@/lib/supabase/client'. On form submit: call supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: `${window.location.origin}/auth/callback` } }). Show success message "Check your email for the magic link". Use iOS-native styling: -apple-system font, rounded corners, safe area padding. Handle loading state during submission. Show error messages if email is invalid or API fails.</action>
  <verify>Page renders at /auth/login with email input, submit calls signInWithOtp, success message appears</verify>
  <done>Form submits email to Supabase, success state shows "check email" message, errors display clearly</done>
</task>

<task type="auto">
  <name>Task 3: Create auth callback route handler</name>
  <files>app/auth/callback/route.ts</files>
  <action>Create Route Handler that exchanges auth code for session. Extract 'code' from URL searchParams. If no code, return NextResponse.redirect to '/auth/error'. Create server Supabase client with createClient from '@/lib/supabase/server'. Call supabase.auth.exchangeCodeForSession(code). If successful, redirect to '/' (home). If error, redirect to '/auth/error'. Use NextResponse.redirect with absolute URL (request.url origin + path).</action>
  <verify>Route handler exists, extracts code param, calls exchangeCodeForSession, redirects appropriately</verify>
  <done>Valid auth code creates session and redirects to home, invalid code redirects to error page</done>
</task>

<task type="auto">
  <name>Task 4: Update environment variables for Supabase</name>
  <files>.env.local</files>
  <action>Check if .env.local has actual Supabase credentials or still has placeholders. If placeholders exist, add comment above them: "# TODO: Replace with actual credentials from https://supabase.com/dashboard/project/_/settings/api". Keep existing NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. Do not create a Supabase project automatically - user must do this via dashboard.</action>
  <verify>cat .env.local shows comment with instructions, variables present</verify>
  <done>Environment file has clear TODO comment for Supabase setup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Middleware file exists at project root with proper matcher
- [ ] Login page renders at /auth/login
- [ ] Callback route exists at /auth/callback
- [ ] .env.local has clear instructions for Supabase credentials
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Magic link flow architecture in place (needs real Supabase project to test end-to-end)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-and-user-model/02-01-SUMMARY.md`:

---
phase: 02-authentication-and-user-model
plan: 01
completed: [DATE]
subsystem: auth
requires: []
provides: [magic-link-auth, auth-middleware, login-page]
affects: [02-02, 02-06]
tags: [auth, supabase, magic-link]
key-decisions:
  - "Magic link authentication (passwordless, no bcrypt needed)"
  - "Middleware handles token refresh on every request"
  - "emailRedirectTo points to /auth/callback for code exchange"
key-files:
  - middleware.ts
  - app/auth/login/page.tsx
  - app/auth/callback/route.ts
tech-stack:
  added: []
  patterns: [magic-link-auth, auth-middleware, callback-route]
---

# Phase 2 Plan 1: Supabase Magic Link Auth Summary

**[One-liner about what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `middleware.ts` - Description
- `app/auth/login/page.tsx` - Description
- `app/auth/callback/route.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[What's ready, what's needed]

## Next Step

Ready for Plan 02-02 (User profile schema and CRUD operations)
</output>
