---
phase: 02-authentication-and-user-model
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [lib/db/schema.sql, lib/db/types.ts, lib/actions/user.ts]
---

<objective>
Create user profile schema and CRUD operations for registered users.

Purpose: Establish database schema for user profiles that extend Supabase's auth.users table with app-specific fields (display name, preferences). Provide type-safe CRUD utilities for managing user profiles.
Output: SQL schema with RLS policies, TypeScript types, and server actions for user profile operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-and-user-model/02-01-SUMMARY.md

**Tech stack available:** Supabase PostgreSQL, Next.js Server Actions, TypeScript
**Established patterns:** SSR-safe auth, server-side database queries
**Key files:** lib/supabase/server.ts

**Constraining decisions:**
- Phase 1: Supabase SSR client established
- PROJECT.md: Hybrid account model (some users are participants without accounts)
- Roadmap: User profiles for registered users, separate participant model for non-users
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user profiles SQL schema with RLS</name>
  <files>lib/db/schema.sql</files>
  <action>Create SQL migration file with:
1. profiles table: id (uuid primary key references auth.users), display_name (text not null), avatar_url (text nullable), currency_preference (text default 'USD'), created_at (timestamptz default now()), updated_at (timestamptz default now())
2. RLS policy: Enable RLS on profiles table
3. Policy "Users can view all profiles" - SELECT for authenticated users (everyone can see profiles for expense sharing)
4. Policy "Users can update own profile" - UPDATE using auth.uid() = id
5. Policy "Users can insert own profile" - INSERT using auth.uid() = id
6. Create trigger for updated_at: update_updated_at_column function and trigger on profiles table
Add comment at top: "Run this in Supabase SQL Editor: https://supabase.com/dashboard/project/_/editor"</action>
  <verify>SQL file exists with proper schema, RLS policies, and updated_at trigger</verify>
  <done>profiles table schema defined with all fields, RLS policies created, trigger for updated_at</done>
</task>

<task type="auto">
  <name>Task 2: Generate TypeScript types for profiles</name>
  <files>lib/db/types.ts</files>
  <action>Create TypeScript types for profiles table. Export type Profile with fields matching schema: { id: string; display_name: string; avatar_url: string | null; currency_preference: string; created_at: string; updated_at: string }. Also export type ProfileInsert (Omit<Profile, 'created_at' | 'updated_at'>) and ProfileUpdate (Partial<Omit<Profile, 'id' | 'created_at' | 'updated_at'>>). Add JSDoc comments explaining these are database types.</action>
  <verify>File exports Profile, ProfileInsert, ProfileUpdate types with correct fields</verify>
  <done>Types accurately reflect database schema, Insert and Update types properly constrained</done>
</task>

<task type="auto">
  <name>Task 3: Create user profile CRUD server actions</name>
  <files>lib/actions/user.ts</files>
  <action>Create Next.js Server Actions for user profile operations. Mark file with 'use server'. Import createClient from '@/lib/supabase/server' and types from '@/lib/db/types'.
Functions to create:
1. getProfile(userId: string): Promise<Profile | null> - Query profiles table by id
2. getCurrentUserProfile(): Promise<Profile | null> - Get profile for authenticated user using supabase.auth.getUser()
3. upsertProfile(profile: ProfileInsert): Promise<Profile> - Insert or update profile (Supabase upsert with onConflict: 'id')
4. updateProfile(userId: string, updates: ProfileUpdate): Promise<Profile> - Update specific fields
All functions should create Supabase server client, handle errors with try-catch, return null on error for getters. Use .single() to unwrap single row results.</action>
  <verify>File exports 4 server actions with proper types, error handling, and Supabase client usage</verify>
  <done>CRUD operations work correctly, error handling prevents crashes, types ensure safety</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] schema.sql is valid SQL (can be pasted into Supabase editor)
- [ ] types.ts exports match schema.sql structure
- [ ] user.ts server actions use correct Supabase client pattern
- [ ] No lint errors in new files
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Database schema ready for Supabase deployment
- Type-safe CRUD utilities available for user profiles
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-and-user-model/02-02-SUMMARY.md`:

---
phase: 02-authentication-and-user-model
plan: 02
completed: [DATE]
subsystem: database
requires: [02-01]
provides: [user-profile-schema, profile-types, profile-crud]
affects: [02-03, 02-05, 02-06]
tags: [database, schema, crud, rls]
key-decisions:
  - "profiles table extends auth.users with app-specific fields"
  - "RLS allows viewing all profiles (for expense participant selection)"
  - "Users can only update own profile"
  - "currency_preference defaults to USD"
key-files:
  - lib/db/schema.sql
  - lib/db/types.ts
  - lib/actions/user.ts
tech-stack:
  added: []
  patterns: [rls-policies, server-actions, type-safe-crud]
---

# Phase 2 Plan 2: User Profile Schema Summary

**[One-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Phase Readiness

## Next Step

Ready for Plan 02-03 (Participant model for non-registered users)
</output>
