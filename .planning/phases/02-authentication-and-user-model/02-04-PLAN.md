---
phase: 02-authentication-and-user-model
plan: 04
type: execute
depends_on: ["02-03"]
files_modified: [lib/actions/invite.ts, app/invite/[token]/page.tsx, lib/utils/token.ts]
---

<objective>
Build email/SMS invite link system for adding participants to expenses.

Purpose: When a user adds someone to an expense by email/phone, generate a secure invite link they can share. Recipient clicks link to view their balances and optionally create an account to claim their participant identity.
Output: Token generation utilities, invite creation server actions, and invite landing page with balance preview.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-and-user-model/02-03-SUMMARY.md

**Tech stack available:** Next.js, TypeScript, crypto (Node.js built-in)
**Established patterns:** Server actions, participant model
**Key files:** lib/actions/participant.ts, lib/db/types.ts

**Constraining decisions:**
- PROJECT.md: Email/SMS invite links, view-only access before account creation
- PROJECT.md: Hybrid model - low-friction onboarding
- Phase 2 Plan 3: Participant model with email/phone fields
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create secure token generation utilities</name>
  <files>lib/utils/token.ts</files>
  <action>Create utilities for invite tokens using Node.js crypto.
Functions:
1. generateInviteToken(): string - Generate cryptographically secure random token (32 bytes, hex encoded)
2. hashToken(token: string): string - Hash token with SHA-256 for storage (don't store raw tokens in DB)
Both use crypto.randomBytes and crypto.createHash from 'node:crypto'. Add JSDoc explaining token security: raw token in URL, hashed token in database prevents token theft if DB compromised.</action>
  <verify>File exports generateInviteToken and hashToken, uses crypto module</verify>
  <done>Functions generate secure tokens, hashing works correctly for storage</done>
</task>

<task type="auto">
  <name>Task 2: Add invite_tokens table to schema</name>
  <files>lib/db/schema.sql</files>
  <action>Append to schema.sql:
1. invite_tokens table: id (uuid primary key default gen_random_uuid()), token_hash (text not null unique), participant_id (uuid not null references participants), created_by_user_id (uuid not null references auth.users), expires_at (timestamptz not null default now() + interval '30 days'), used_at (timestamptz nullable), created_at (timestamptz default now())
2. Index on token_hash: CREATE INDEX idx_invite_tokens_hash ON invite_tokens(token_hash)
3. Index on participant_id: CREATE INDEX idx_invite_tokens_participant ON invite_tokens(participant_id)
4. RLS policies:
   - "Anyone can view valid invite tokens" (SELECT where expires_at > now() AND used_at IS NULL) - needed for invite page
   - "Users can create invite tokens" (INSERT for authenticated)
   - "Tokens can be marked as used" (UPDATE used_at where expires_at > now())
Note: Public SELECT is intentional - invite page needs to fetch by token_hash before auth.</action>
  <verify>schema.sql has invite_tokens table with proper constraints, indexes, RLS</verify>
  <done>invite_tokens schema complete, 30-day expiry default, token_hash indexed for lookups</done>
</task>

<task type="auto">
  <name>Task 3: Add InviteToken types and create invite server actions</name>
  <files>lib/db/types.ts, lib/actions/invite.ts</files>
  <action>First, add to lib/db/types.ts:
Export type InviteToken: { id: string; token_hash: string; participant_id: string; created_by_user_id: string; expires_at: string; used_at: string | null; created_at: string }

Then create lib/actions/invite.ts with 'use server':
1. createInvite(participantId: string): Promise<{ token: string; inviteUrl: string } | null> - Generate token, hash it, insert invite_tokens record, return raw token and full URL (protocol + host + /invite/[token])
2. getInviteByToken(token: string): Promise<{ participant: Participant; isValid: boolean } | null> - Hash token, query invite_tokens by token_hash, check expiry and used_at, fetch participant details, return { participant, isValid }
3. markInviteUsed(token: string): Promise<boolean> - Hash token, update used_at to now()
Use environment variable NEXT_PUBLIC_APP_URL for base URL (default to http://localhost:3000 for dev). Import hashToken from '@/lib/utils/token'.</action>
  <verify>types.ts has InviteToken type, invite.ts exports 3 functions with token hashing</verify>
  <done>Invite creation generates URL, getInviteByToken validates expiry/usage, markInviteUsed works</done>
</task>

<task type="auto">
  <name>Task 4: Create invite landing page</name>
  <files>app/invite/[token]/page.tsx</files>
  <action>Create dynamic route for /invite/[token]. Server component that:
1. Extracts token from params
2. Calls getInviteByToken(token) to fetch participant and validate
3. If invalid/expired: Show "This invite link has expired or is invalid"
4. If valid: Show participant name, explain "You've been added to expenses by [creator]", show "Your current balance: [placeholder - will calculate in Phase 6]", display two CTAs:
   - "Create Account to Claim" (links to /auth/login with ?participant=[id] query param)
   - "View as Guest" (placeholder for now - will implement balance viewing in Phase 6)
Use iOS-native styling with safe-area-inset padding, -apple-system font, rounded buttons.</action>
  <verify>Page renders at /invite/[token], handles valid/invalid tokens, shows participant info and CTAs</verify>
  <done>Invite landing page works, validates token, displays participant name and action options</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] schema.sql has invite_tokens table with RLS and indexes
- [ ] token.ts generates secure tokens and hashes correctly
- [ ] invite.ts creates invites and validates tokens
- [ ] /invite/[token] page renders with proper error handling
- [ ] No lint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Invite link generation works with secure tokens
- Invite landing page validates tokens and shows participant info
- Ready for account claiming flow (Plan 02-05)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-and-user-model/02-04-SUMMARY.md`:

---
phase: 02-authentication-and-user-model
plan: 04
completed: [DATE]
subsystem: invites
requires: [02-03]
provides: [invite-tokens, invite-links, invite-landing-page]
affects: [02-05]
tags: [invites, security, tokens]
key-decisions:
  - "Secure token generation with crypto.randomBytes (32 bytes)"
  - "Token hashing with SHA-256 before storage (prevents token theft)"
  - "30-day expiry default for invite links"
  - "Public RLS SELECT on invite_tokens (needed for unauthenticated invite page)"
  - "Invite landing page shows participant info and account claim CTA"
key-files:
  - lib/utils/token.ts
  - lib/db/schema.sql
  - lib/db/types.ts
  - lib/actions/invite.ts
  - app/invite/[token]/page.tsx
tech-stack:
  added: [crypto (node:crypto)]
  patterns: [secure-token-generation, token-hashing, invite-links]
---

# Phase 2 Plan 4: Invite Link System Summary

**[One-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Phase Readiness

## Next Step

Ready for Plan 02-05 (Account claiming flow) - can run in parallel with 02-04 once 02-03 complete
</output>
