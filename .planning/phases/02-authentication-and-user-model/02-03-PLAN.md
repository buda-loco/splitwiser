---
phase: 02-authentication-and-user-model
plan: 03
type: execute
depends_on: ["02-02"]
files_modified: [lib/db/schema.sql, lib/db/types.ts, lib/actions/participant.ts]
---

<objective>
Implement participant model for non-registered users.

Purpose: Enable tracking expenses with people who haven't created accounts yet. Participants have name and optional email/phone but no login credentials. This supports the hybrid account model and low-friction onboarding.
Output: participants table schema with RLS, TypeScript types, and CRUD operations for managing non-user participants.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-and-user-model/02-02-SUMMARY.md

**Tech stack available:** Supabase PostgreSQL, Next.js Server Actions, TypeScript
**Established patterns:** RLS policies, server-actions, type-safe-crud
**Key files:** lib/db/schema.sql, lib/db/types.ts, lib/actions/user.ts

**Constraining decisions:**
- PROJECT.md: Hybrid account model - track expenses with non-users, they can claim accounts later
- PROJECT.md: Email/SMS invite links when someone adds you
- Phase 2 Plan 2: User profile schema established
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add participants table to SQL schema</name>
  <files>lib/db/schema.sql</files>
  <action>Append to existing schema.sql file (after profiles table):
1. participants table: id (uuid primary key default gen_random_uuid()), name (text not null), email (text nullable), phone (text nullable), claimed_by_user_id (uuid nullable references auth.users), created_by_user_id (uuid not null references auth.users), created_at (timestamptz default now()), updated_at (timestamptz default now())
2. Add index on email (for invite link lookups): CREATE INDEX idx_participants_email ON participants(email) WHERE email IS NOT NULL
3. Add index on claimed_by_user_id: CREATE INDEX idx_participants_claimed ON participants(claimed_by_user_id) WHERE claimed_by_user_id IS NOT NULL
4. RLS policies:
   - "Users can view participants they created or are involved with" (SELECT where created_by_user_id = auth.uid() OR id IN (subquery for participants in user's expenses))
   - "Users can insert participants" (INSERT for authenticated)
   - "Users can update own participants" (UPDATE where created_by_user_id = auth.uid())
5. Add trigger for updated_at on participants table
Note: Simplified RLS for v1 - users see participants they created. Will refine when expenses table exists in Phase 3.</action>
  <verify>schema.sql has participants table with all fields, indexes, RLS policies, updated_at trigger</verify>
  <done>participants schema complete with proper constraints, indexes for performance, RLS for security</done>
</task>

<task type="auto">
  <name>Task 2: Add participant types to types.ts</name>
  <files>lib/db/types.ts</files>
  <action>Add to existing lib/db/types.ts:
Export type Participant: { id: string; name: string; email: string | null; phone: string | null; claimed_by_user_id: string | null; created_by_user_id: string; created_at: string; updated_at: string }
Export type ParticipantInsert: Omit<Participant, 'id' | 'created_at' | 'updated_at' | 'claimed_by_user_id'> (name, email, phone, created_by_user_id required)
Export type ParticipantUpdate: Partial<Pick<Participant, 'name' | 'email' | 'phone'>> (only updatable fields)
Add JSDoc explaining participants are non-users who can claim accounts later.</action>
  <verify>types.ts exports Participant, ParticipantInsert, ParticipantUpdate with correct fields</verify>
  <done>Participant types match schema, Insert/Update types properly constrained</done>
</task>

<task type="auto">
  <name>Task 3: Create participant CRUD server actions</name>
  <files>lib/actions/participant.ts</files>
  <action>Create new file with 'use server'. Import createClient from '@/lib/supabase/server' and Participant types.
Functions:
1. createParticipant(data: Omit<ParticipantInsert, 'created_by_user_id'>): Promise<Participant | null> - Get current user ID from auth, insert participant with created_by_user_id set to current user
2. getParticipant(id: string): Promise<Participant | null> - Fetch by id
3. getParticipantByEmail(email: string): Promise<Participant | null> - Find unclaimed participant by email (claimed_by_user_id IS NULL)
4. getUserParticipants(): Promise<Participant[]> - Get all participants created by current user
5. updateParticipant(id: string, updates: ParticipantUpdate): Promise<Participant | null> - Update name/email/phone for participant user created
6. claimParticipant(participantId: string, userId: string): Promise<Participant | null> - Set claimed_by_user_id (used in account claiming flow later)
All functions use try-catch, return null on error, use .single() for single row results, .maybeSingle() for optional results.</action>
  <verify>File exports 6 server actions with proper auth checks, error handling, Supabase client usage</verify>
  <done>Participant CRUD works, getParticipantByEmail finds unclaimed only, claimParticipant updates correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] schema.sql has valid participants table with indexes and RLS
- [ ] types.ts exports Participant types matching schema
- [ ] participant.ts has 6 server actions with auth integration
- [ ] No lint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Participant model ready for expense creation (Phase 4)
- Account claiming infrastructure in place (for Phase 2 Plan 5)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-and-user-model/02-03-SUMMARY.md`:

---
phase: 02-authentication-and-user-model
plan: 03
completed: [DATE]
subsystem: database
requires: [02-02]
provides: [participant-schema, participant-types, participant-crud]
affects: [02-04, 02-05]
tags: [database, schema, hybrid-model]
key-decisions:
  - "Participants are non-users with name and optional contact info"
  - "claimed_by_user_id links participant to user account when claimed"
  - "RLS allows viewing participants you created (simplified for v1)"
  - "Indexes on email and claimed_by_user_id for invite/claim lookups"
key-files:
  - lib/db/schema.sql
  - lib/db/types.ts
  - lib/actions/participant.ts
tech-stack:
  added: []
  patterns: [hybrid-account-model, participant-claiming]
---

# Phase 2 Plan 3: Participant Model Summary

**[One-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Phase Readiness

## Next Step

Ready for Plan 02-04 (Email/SMS invite link system) - can run in parallel with 02-05
</output>
