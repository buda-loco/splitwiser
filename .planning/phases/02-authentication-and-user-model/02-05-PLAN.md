---
phase: 02-authentication-and-user-model
plan: 05
type: execute
depends_on: ["02-03"]
files_modified: [app/auth/claim/page.tsx, lib/actions/claim.ts]
---

<objective>
Create account claiming flow (non-user becomes user).

Purpose: Enable participants to claim their identity when creating an account. When they sign up via magic link from an invite, automatically link their new user account to their existing participant record, preserving all expense history and balances.
Output: Account claiming page with participant selection, claim action that updates claimed_by_user_id, and automatic profile creation from participant data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-and-user-model/02-02-SUMMARY.md
@.planning/phases/02-authentication-and-user-model/02-03-SUMMARY.md

**Tech stack available:** Supabase Auth, Next.js Server Actions, TypeScript
**Established patterns:** Server actions, participant model, user profiles
**Key files:** lib/actions/user.ts, lib/actions/participant.ts

**Constraining decisions:**
- PROJECT.md: Hybrid account model - participants can claim accounts later
- Phase 2 Plan 2: User profile schema with display_name
- Phase 2 Plan 3: Participant model with claimed_by_user_id field
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create account claiming server actions</name>
  <files>lib/actions/claim.ts</files>
  <action>Create 'use server' file with account claiming logic. Import createClient from '@/lib/supabase/server', user and participant actions.
Functions:
1. getClaimableParticipants(email: string): Promise<Participant[]> - Find all unclaimed participants (claimed_by_user_id IS NULL) matching email
2. claimParticipantAccount(participantId: string): Promise<{ success: boolean; error?: string }> - Get current authenticated user, verify participant is unclaimed, update participant.claimed_by_user_id to current user's ID, create/update user profile with participant's name as display_name. Use transaction-like logic: if profile creation fails, return error but don't rollback participant claim (participant claim is source of truth). Return { success: true } on success, { success: false, error: 'message' } on failure.
3. autoClaimOnLogin(email: string): Promise<void> - Helper called after magic link login: find claimable participants by email, if exactly one exists, auto-claim it. If multiple, show claiming UI (Task 2).
Use try-catch with proper error messages. Call claimParticipant from participant.ts and upsertProfile from user.ts.</action>
  <verify>claim.ts exports 3 functions with proper auth checks, error handling, and participant/profile updates</verify>
  <done>Claiming flow works, updates claimed_by_user_id, creates profile, handles errors gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create account claiming UI page</name>
  <files>app/auth/claim/page.tsx</files>
  <action>Create server component page for /auth/claim (used when user has multiple claimable participants).
1. Get current user from Supabase auth
2. If not authenticated, redirect to /auth/login
3. Get user's email, call getClaimableParticipants(email)
4. If no claimable participants: Show "No accounts to claim" with link to home
5. If claimable participants exist: Show list with participant name, "Created by [creator]", and "Claim This Account" button for each
6. Claim button triggers claimParticipantAccount server action, shows loading state, redirects to home on success
Use iOS-native styling with list rows, checkmarks for claimed accounts, safe-area padding. Client component for interactive claim buttons ('use client' on nested component).</action>
  <verify>/auth/claim page renders, shows claimable participants, claim button works with loading state</verify>
  <done>Claim page lists participants, buttons trigger claim action, success redirects home, errors display clearly</done>
</task>

<task type="auto">
  <name>Task 3: Integrate auto-claim into auth callback</name>
  <files>app/auth/callback/route.ts</files>
  <action>Update existing auth callback route handler from Plan 02-01. After successful exchangeCodeForSession:
1. Get user from session
2. If user has email, call autoClaimOnLogin(user.email)
3. If auto-claim finds multiple participants, redirect to /auth/claim instead of home
4. If auto-claim succeeds or finds no participants, redirect to home as before
Import autoClaimOnLogin from '@/lib/actions/claim'. Keep existing error handling. This makes claiming automatic for simple cases (1 participant per email).</action>
  <verify>Callback route attempts auto-claim after login, redirects to /auth/claim for multiple matches</verify>
  <done>Auto-claim works on login, single participant auto-claimed, multiple participants show claim UI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] claim.ts functions handle auth, participant updates, profile creation
- [ ] /auth/claim page renders and handles claiming
- [ ] Callback route integrates auto-claim logic
- [ ] No lint errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Account claiming works automatically or via UI
- Participant-to-user linking preserves expense history
- Profile created from participant data on claim
  </success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-and-user-model/02-05-SUMMARY.md`:

---
phase: 02-authentication-and-user-model
plan: 05
completed: [DATE]
subsystem: auth
requires: [02-03]
provides: [account-claiming, auto-claim-on-login]
affects: [02-06]
tags: [auth, claiming, hybrid-model]
key-decisions:
  - "Auto-claim single participant on login (UX simplification)"
  - "Manual claim UI for multiple participants per email"
  - "Profile created from participant name on claim"
  - "claimed_by_user_id links participant to user account"
  - "Claim is source of truth (even if profile creation fails)"
key-files:
  - lib/actions/claim.ts
  - app/auth/claim/page.tsx
  - app/auth/callback/route.ts
tech-stack:
  added: []
  patterns: [auto-claiming, participant-to-user-linking]
---

# Phase 2 Plan 5: Account Claiming Flow Summary

**[One-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Phase Readiness

## Next Step

Ready for Plan 02-06 (Authentication context and protected routes)
</output>
