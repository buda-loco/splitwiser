---
phase: 03-data-model-and-offline-foundation
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/20260206000001_create_core_schema.sql]
---

<objective>
Design and implement complete database schema for expenses, participants, tags, splits, and settlements.

Purpose: Establish the foundational data model that all expense management features depend on. Schema must support offline-first architecture, multi-currency expenses, flexible splitting methods, and version history tracking.
Output: Supabase migration creating all core tables with proper relationships, constraints, and RLS policies.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@lib/db/types.ts

**Tech stack available:**
- Next.js 15 with App Router
- Supabase (configured, auth ready)
- TypeScript with strict mode
- Framer Motion, Tailwind CSS

**Established patterns:**
- Server actions in lib/actions/
- Supabase client utilities (lib/supabase/)
- Type definitions in lib/db/types.ts

**Constraining decisions:**
- Phase 2: User profiles and participant hybrid model established
- Phase 2: Invite token system for onboarding non-users
- Offline-first architecture required (PROJECT.md constraint)
- Tags instead of groups for organization
- Global balances per person across all tags
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase migrations directory structure</name>
  <files>supabase/migrations/20260206000001_create_core_schema.sql</files>
  <action>Create supabase/ directory at project root if not exists. Create supabase/migrations/ subdirectory. Create initial migration file with timestamp-based naming convention (20260206000001_create_core_schema.sql). Include header comment explaining this is the core schema migration for expense splitting functionality.</action>
  <verify>ls supabase/migrations/20260206000001_create_core_schema.sql exists</verify>
  <done>Directory structure created, migration file exists with header comment</done>
</task>

<task type="auto">
  <name>Task 2: Design and implement complete database schema</name>
  <files>supabase/migrations/20260206000001_create_core_schema.sql</files>
  <action>Write SQL migration creating all core tables with proper relationships and constraints. Include:

**Tables to create:**

1. **expenses** table:
   - id (uuid primary key, default gen_random_uuid())
   - amount (decimal(12,2) not null) - max 9,999,999,999.99
   - currency (varchar(3) not null) - ISO 4217 code (USD, EUR, AUD)
   - description (text not null)
   - category (varchar(50)) - nullable, optional categorization
   - expense_date (timestamptz not null) - when expense occurred
   - paid_by_user_id (uuid references auth.users(id)) - who paid
   - created_by_user_id (uuid not null references auth.users(id))
   - is_deleted (boolean default false) - soft delete flag
   - version (integer default 1) - for version history tracking
   - created_at (timestamptz default now())
   - updated_at (timestamptz default now())
   - deleted_at (timestamptz) - when soft deleted
   - Indexes: paid_by_user_id, created_by_user_id, expense_date, is_deleted

2. **expense_participants** junction table:
   - id (uuid primary key, default gen_random_uuid())
   - expense_id (uuid not null references expenses(id) on delete cascade)
   - user_id (uuid references auth.users(id)) - for registered users
   - participant_id (uuid references participants(id)) - for non-registered
   - created_at (timestamptz default now())
   - Constraint: CHECK (user_id IS NOT NULL OR participant_id IS NOT NULL) - must have one
   - Unique constraint: (expense_id, user_id), (expense_id, participant_id) - no duplicates
   - Index: expense_id for fast lookups

3. **expense_splits** table:
   - id (uuid primary key, default gen_random_uuid())
   - expense_id (uuid not null references expenses(id) on delete cascade)
   - user_id (uuid references auth.users(id))
   - participant_id (uuid references participants(id))
   - amount (decimal(12,2) not null) - what this person owes
   - split_type (varchar(20) not null) - 'equal', 'percentage', 'shares', 'exact'
   - split_value (decimal(10,4)) - percentage (0-100) or share weight (0.5, 1, 2)
   - created_at (timestamptz default now())
   - Constraint: CHECK (user_id IS NOT NULL OR participant_id IS NOT NULL)
   - Index: expense_id, user_id, participant_id

4. **expense_tags** junction table:
   - id (uuid primary key, default gen_random_uuid())
   - expense_id (uuid not null references expenses(id) on delete cascade)
   - tag (varchar(100) not null) - hashtag without # prefix, lowercase
   - created_at (timestamptz default now())
   - Unique constraint: (expense_id, tag) - same tag can't be added twice
   - Index: tag for filtering, expense_id for lookups

5. **settlements** table:
   - id (uuid primary key, default gen_random_uuid())
   - from_user_id (uuid references auth.users(id))
   - from_participant_id (uuid references participants(id))
   - to_user_id (uuid references auth.users(id))
   - to_participant_id (uuid references participants(id))
   - amount (decimal(12,2) not null)
   - currency (varchar(3) not null)
   - settlement_type (varchar(20) not null) - 'global', 'tag_specific', 'partial'
   - tag (varchar(100)) - for tag_specific settlements
   - settlement_date (timestamptz not null)
   - created_by_user_id (uuid not null references auth.users(id))
   - created_at (timestamptz default now())
   - Constraint: CHECK (from_user_id IS NOT NULL OR from_participant_id IS NOT NULL)
   - Constraint: CHECK (to_user_id IS NOT NULL OR to_participant_id IS NOT NULL)
   - Index: from_user_id, to_user_id, settlement_date

6. **expense_versions** table for edit history:
   - id (uuid primary key, default gen_random_uuid())
   - expense_id (uuid not null references expenses(id) on delete cascade)
   - version_number (integer not null)
   - changed_by_user_id (uuid not null references auth.users(id))
   - change_type (varchar(20) not null) - 'created', 'updated', 'deleted', 'restored'
   - changes (jsonb not null) - diff of what changed
   - created_at (timestamptz default now())
   - Index: expense_id, version_number

**Avoid:**
- DO NOT use "groups" table (PROJECT.md decision: tags instead of groups)
- DO NOT create separate currency_rates table yet (Phase 6 handles this)
- DO NOT add receipt/image fields (out of scope per PROJECT.md)
- DO NOT use SERIAL for IDs (use uuid for distributed/offline compatibility)

Use TIMESTAMPTZ not TIMESTAMP (timezone aware). Use DECIMAL not FLOAT (precise money). All money amounts: decimal(12,2) format.</action>
  <verify>psql or cat supabase/migrations/20260206000001_create_core_schema.sql shows all 6 tables with proper columns, constraints, indexes</verify>
  <done>Migration SQL contains all 6 tables (expenses, expense_participants, expense_splits, expense_tags, settlements, expense_versions) with relationships, constraints, and indexes. No groups table. Uses uuid, timestamptz, decimal types correctly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration file exists at supabase/migrations/20260206000001_create_core_schema.sql
- [ ] All 6 tables defined with complete column specifications
- [ ] Foreign key relationships properly defined with ON DELETE CASCADE where appropriate
- [ ] Proper constraints (CHECK, UNIQUE, NOT NULL) in place
- [ ] Indexes created for frequently queried columns
- [ ] Uses uuid, timestamptz, decimal types (not serial, timestamp, float)
</verification>

<success_criteria>
- Migration file created and ready for deployment
- Schema supports all core requirements: expenses, splits, tags, settlements, version history
- Schema supports hybrid user/participant model
- Schema prepared for offline-first patterns (uuid IDs)
- No groups table (tags-based architecture)
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-model-and-offline-foundation/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Database Schema Design Summary

**Complete expense splitting schema with 6 core tables and relationships**

## Accomplishments

- Created Supabase migrations directory structure
- Designed comprehensive schema for expense management
- Implemented proper constraints, indexes, and foreign keys
- Schema supports hybrid user/participant model
- Schema prepared for offline-first architecture with uuid IDs

## Files Created/Modified

- `supabase/migrations/20260206000001_create_core_schema.sql` - Core schema migration

## Decisions Made

[Document any schema design decisions made during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (Create RLS policies and deploy migration to Supabase)
</output>
