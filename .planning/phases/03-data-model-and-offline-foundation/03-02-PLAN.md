---
phase: 03-data-model-and-offline-foundation
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [supabase/migrations/20260206000002_create_rls_policies.sql]
---

<objective>
Create Row Level Security (RLS) policies for all tables and deploy migrations to Supabase.

Purpose: Secure the database with proper access control policies that enforce data privacy while supporting collaborative expense sharing. Deploy the complete schema to Supabase project.
Output: RLS policies migration, both migrations applied to Supabase, schema live and secured.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-data-model-and-offline-foundation/03-01-SUMMARY.md
@supabase/migrations/20260206000001_create_core_schema.sql

**Tech stack available:**
- Supabase with auth.users table
- RLS enabled by default on new tables
- PostgreSQL 15+ features available

**Constraining decisions:**
- Phase 2: User authentication established
- Expenses are collaborative (visible to all participants)
- Participants can be created by any authenticated user
- Settlements visible to both parties involved
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS policies migration</name>
  <files>supabase/migrations/20260206000002_create_rls_policies.sql</files>
  <action>Create new migration file for RLS policies. Enable RLS on all tables. Create policies following these security rules:

**expenses table:**
- SELECT: User can see expenses they created, paid for, or are a participant in
- INSERT: Any authenticated user can create expenses
- UPDATE: Only creator can update their own expenses (check created_by_user_id = auth.uid())
- DELETE: Only creator can soft-delete (set is_deleted = true, deleted_at = now())

**expense_participants:**
- SELECT: User can see participants for expenses they have access to
- INSERT: User can add participants when creating/editing their own expenses
- UPDATE: Not needed (immutable after creation)
- DELETE: User can remove participants from their own expenses

**expense_splits:**
- SELECT: User can see splits for expenses they have access to
- INSERT: User can create splits when creating/editing their own expenses
- UPDATE: User can update splits for their own expenses
- DELETE: User can delete splits from their own expenses

**expense_tags:**
- SELECT: User can see tags for expenses they have access to
- INSERT: User can tag their own expenses
- DELETE: User can remove tags from their own expenses

**settlements:**
- SELECT: User can see settlements where they are from_user_id or to_user_id
- INSERT: Any authenticated user can record settlements
- UPDATE: Only creator can update (created_by_user_id = auth.uid())
- DELETE: Only creator can delete

**expense_versions:**
- SELECT: User can see versions for expenses they have access to
- INSERT: System only (triggered by expense changes)
- UPDATE: Never allowed
- DELETE: Never allowed (audit log)

Use helper functions for complex checks:
- CREATE FUNCTION can_access_expense(expense_id uuid) - returns true if user created, paid, or is participant
- Use EXISTS clauses with expense_participants join to check participation

**Avoid:**
- DO NOT use overly permissive policies (e.g., SELECT for all authenticated users on all tables)
- DO NOT forget to enable RLS with ALTER TABLE ... ENABLE ROW LEVEL SECURITY
- DO NOT skip expense_versions policies (even if read-only)</action>
  <verify>cat supabase/migrations/20260206000002_create_rls_policies.sql shows ALTER TABLE ENABLE RLS for all tables, helper functions, and policies for all operations</verify>
  <done>RLS enabled on all 6 tables, helper function created, policies covering SELECT/INSERT/UPDATE/DELETE for each table with proper security model</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy migrations to Supabase project</action>
  <instructions>
    I've created the database migrations but need your Supabase project connection to deploy them.

    Run these commands:
    1. Install Supabase CLI if not already: `npm install -g supabase`
    2. Link to your project: `npx supabase link --project-ref YOUR_PROJECT_REF`
       (Project ref is in your Supabase dashboard URL or .env.local)
    3. Deploy migrations: `npx supabase db push`

    The migrations will create all tables and RLS policies in your Supabase project.
  </instructions>
  <verification>npx supabase db remote ls shows the 2 migrations applied</verification>
  <resume-signal>Type "done" when migrations are deployed, or share any errors</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RLS migration file created with all policies
- [ ] RLS enabled on all 6 tables
- [ ] Helper function for can_access_expense exists
- [ ] Policies cover all CRUD operations appropriately
- [ ] Migrations deployed to Supabase successfully
- [ ] npx supabase db remote ls shows both migrations
</verification>

<success_criteria>
- RLS policies migration created
- Security model properly enforces collaborative access
- Expense_versions audit log protected from modification
- Both migrations deployed to Supabase
- Schema live and secured in database
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-model-and-offline-foundation/03-02-SUMMARY.md`:

# Phase 3 Plan 2: RLS Policies and Migration Deployment Summary

**Database secured with Row Level Security and deployed to Supabase**

## Accomplishments

- Created comprehensive RLS policies for all tables
- Implemented helper function for expense access checks
- Deployed both migrations to Supabase project
- Schema now live with proper security model

## Files Created/Modified

- `supabase/migrations/20260206000002_create_rls_policies.sql` - RLS policies migration

## Decisions Made

[Document RLS policy decisions, any policy refinements made]

## Issues Encountered

[Migration deployment issues, policy adjustments needed, or "None"]

## Next Step

Ready for 03-03-PLAN.md (Implement IndexedDB wrapper for offline storage)
</output>
