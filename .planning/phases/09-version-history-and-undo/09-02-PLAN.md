---
phase: 09-version-history-and-undo
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [components/ExpenseVersionHistory.tsx, app/expenses/[id]/page.tsx]
---

<objective>
Create version history view showing all changes made to an expense.

Purpose: Allow users to see who changed what and when for transparency and audit trail.
Output: Version history component displayed on expense detail page showing timeline of all modifications.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-version-history-and-undo/09-01-SUMMARY.md
@components/ExpenseDetail.tsx
@app/expenses/[id]/page.tsx
@lib/db/types.ts
@lib/db/stores.ts

**Tech stack available:** Next.js 15, React, TypeScript, Tailwind, Framer Motion
**Established patterns:**
- iOS-native styling with design tokens
- Framer Motion animations for list items
- Collapsible sections with AnimatePresence
- Time formatting with relative dates

**From 09-01:**
- getExpenseVersions(expense_id) returns all versions sorted by version_number desc
- OfflineExpenseVersion type with changes.before and changes.after
- change_type: created, updated, deleted, restored
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpenseVersionHistory component</name>
  <files>components/ExpenseVersionHistory.tsx</files>
  <action>
Create collapsible version history component following existing patterns:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { getExpenseVersions } from '@/lib/db/stores';
import type { OfflineExpenseVersion } from '@/lib/db/types';

export function ExpenseVersionHistory({ expenseId }: { expenseId: string }) {
  const [versions, setVersions] = useState<OfflineExpenseVersion[]>([]);
  const [loading, setLoading] = useState(true);
  const [expanded, setExpanded] = useState(false);

  useEffect(() => {
    async function loadVersions() {
      const v = await getExpenseVersions(expenseId);
      setVersions(v);
      setLoading(false);
    }
    loadVersions();
  }, [expenseId]);

  if (loading) return null; // Don't show loader - optional section
  if (versions.length === 0) return null; // No history yet

  return (
    <div className="bg-white dark:bg-ios-gray1 rounded-xl p-4 shadow-sm">
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center justify-between"
      >
        <h3 className="text-base font-semibold text-ios-black dark:text-white">
          Version History ({versions.length})
        </h3>
        <motion.svg
          animate={{ rotate: expanded ? 180 : 0 }}
          className="w-5 h-5 text-ios-gray dark:text-ios-gray3"
        >
          {/* Chevron down icon */}
        </motion.svg>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            className="mt-4 space-y-2"
          >
            {versions.map((version) => (
              <div
                key={version.id}
                className="p-3 bg-ios-gray6 dark:bg-ios-gray2 rounded-lg"
              >
                <div className="flex items-start justify-between mb-1">
                  <span className="text-sm font-medium text-ios-black dark:text-white capitalize">
                    {version.change_type}
                  </span>
                  <span className="text-xs text-ios-gray dark:text-ios-gray3">
                    {formatRelativeTime(version.created_at)}
                  </span>
                </div>
                <p className="text-xs text-ios-gray dark:text-ios-gray3">
                  Version {version.version_number}
                </p>
                {renderChanges(version)}
              </div>
            ))}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

function renderChanges(version: OfflineExpenseVersion) {
  const { before, after } = version.changes;
  if (!before && !after) return null;

  // For 'created', show all fields
  if (version.change_type === 'created' && after) {
    return (
      <div className="mt-2 text-xs text-ios-gray dark:text-ios-gray3">
        Amount: {after.amount} {after.currency}
        {after.description && <span> • {after.description}</span>}
      </div>
    );
  }

  // For 'updated', show what changed
  if (version.change_type === 'updated' && before && after) {
    const changes = [];
    if (before.amount !== after.amount) {
      changes.push(`Amount: ${before.amount} → ${after.amount}`);
    }
    if (before.description !== after.description) {
      changes.push(`Description: "${before.description}" → "${after.description}"`);
    }
    if (before.category !== after.category) {
      changes.push(`Category: ${before.category || 'None'} → ${after.category || 'None'}`);
    }
    return changes.length > 0 ? (
      <div className="mt-2 text-xs text-ios-gray dark:text-ios-gray3 space-y-0.5">
        {changes.map((c, i) => <div key={i}>{c}</div>)}
      </div>
    ) : null;
  }

  // For 'deleted' and 'restored', just show the action
  return null;
}

function formatRelativeTime(timestamp: string): string {
  const now = new Date();
  const then = new Date(timestamp);
  const diffMs = now.getTime() - then.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return then.toLocaleDateString();
}
```

Follow ExpenseList patterns: collapsible sections, iOS-native styling, Framer Motion animations.
Don't over-engineer the diff display - show key fields only (amount, description, category).
Use formatRelativeTime for human-readable timestamps ("2h ago", "3d ago").
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>ExpenseVersionHistory component created with collapsible timeline, change rendering, iOS-native styling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate version history into expense detail page</name>
  <files>app/expenses/[id]/page.tsx</files>
  <action>
Add ExpenseVersionHistory component to expense detail page:

```typescript
import { ExpenseVersionHistory } from '@/components/ExpenseVersionHistory';

// Inside ExpenseDetailPage component, after ExpenseDetail:
<ExpenseVersionHistory expenseId={params.id} />
```

Place after ExpenseDetail component in the page layout.
Version history is optional - only shows if versions exist.
  </action>
  <verify>Page renders without errors, version history section appears when expanded</verify>
  <done>Version history integrated into expense detail page, displays timeline of changes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (`npx tsc --noEmit`)
- [ ] Version history component loads versions from IndexedDB
- [ ] Collapsible section expands/collapses smoothly
- [ ] Changes displayed clearly (created, updated, deleted)
- [ ] Relative time formatting works ("2h ago", "3d ago")
- [ ] iOS-native styling matches existing patterns
</verification>

<success_criteria>

- ExpenseVersionHistory component created with collapsible UI
- Version timeline shows change_type, timestamp, version_number
- Change rendering for created/updated types
- Relative time formatting
- Integrated into expense detail page
- All verification checks pass
- No TypeScript errors introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/09-version-history-and-undo/09-02-SUMMARY.md`:

# Phase 9 Plan 2: Version History View Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `file.tsx` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 09-04-PLAN.md (undo system) or complete in parallel with 09-03
</output>
