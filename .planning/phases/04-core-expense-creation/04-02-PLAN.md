---
phase: 04-core-expense-creation
plan: 02
type: execute
depends_on: []
files_modified: [components/ParticipantPicker.tsx, hooks/useParticipants.ts]
---

<objective>
Build participant selection UI with smart suggestions based on expense history.

Purpose: Enable quick participant selection for expenses with suggestions from recent/frequent collaborators.
Output: Reusable ParticipantPicker component that suggests and manages expense participants.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-model-and-offline-foundation/03-03-SUMMARY.md
@lib/db/stores.ts
@lib/db/types.ts
@components/BottomNav.tsx

**Tech stack available:**
- React 19 with hooks
- IndexedDB stores with getExpenses, addParticipantToExpense
- Participant CRUD operations from Phase 3
- iOS-native UI patterns

**Established patterns:**
- Hybrid user/participant model (user_id OR participant_id)
- IndexedDB as source of truth
- iOS-native component styling

**Constraining decisions:**
- Phase 3: Hybrid model supports both registered users and non-registered participants
- PROJECT: Tags organizational, balances global per person
- Phase 1: iOS-native UX with gesture-driven interactions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useParticipants hook for smart suggestions</name>
  <files>hooks/useParticipants.ts</files>
  <action>Create React hook that provides participant suggestions based on expense history:

**Hook structure:**
```tsx
'use client';

import { useState, useEffect } from 'react';
import { getExpenses, getExpenseParticipants } from '@/lib/db/stores';
import type { Participant } from '@/lib/db/types';

export function useParticipants() {
  const [recent, setRecent] = useState<Participant[]>([]);
  const [frequent, setFrequent] = useState<Participant[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadSuggestions() {
      // Get all expenses (most recent first)
      const expenses = await getExpenses({ limit: 50 });

      // Extract participants from recent expenses
      const participantMap = new Map<string, { participant: Participant; count: number; lastSeen: number }>();

      for (const expense of expenses) {
        const participants = await getExpenseParticipants(expense.id);

        for (const p of participants) {
          const key = p.user_id || p.participant_id || '';
          const existing = participantMap.get(key);

          if (existing) {
            existing.count++;
          } else {
            participantMap.set(key, {
              participant: p,
              count: 1,
              lastSeen: new Date(expense.expense_date).getTime()
            });
          }
        }
      }

      // Sort by most recent (last 10)
      const byRecent = Array.from(participantMap.values())
        .sort((a, b) => b.lastSeen - a.lastSeen)
        .slice(0, 10)
        .map(item => item.participant);

      // Sort by most frequent (top 10)
      const byFrequent = Array.from(participantMap.values())
        .sort((a, b) => b.count - a.count)
        .slice(0, 10)
        .map(item => item.participant);

      setRecent(byRecent);
      setFrequent(byFrequent);
      setLoading(false);
    }

    loadSuggestions();
  }, []);

  return { recent, frequent, loading };
}
```

**Smart suggestion logic:**
- Analyzes last 50 expenses
- Extracts participants, counts frequency, tracks last seen
- Returns two lists: recent (last used) and frequent (most common)
- Deduplicates by user_id/participant_id

**Avoid:**
- DO NOT make network calls (use IndexedDB only)
- DO NOT load all expenses (limit to 50 for performance)
- DO NOT include current user in suggestions (they're always included)</action>
  <verify>TypeScript compiles, hook returns recent and frequent participant lists, suggestions update when expenses change</verify>
  <done>useParticipants hook created with smart suggestion logic analyzing expense history, returns recent and frequent participants</done>
</task>

<task type="auto">
  <name>Task 2: Create ParticipantPicker component with suggestions UI</name>
  <files>components/ParticipantPicker.tsx</files>
  <action>Create iOS-native participant selection component:

**Component structure:**
```tsx
'use client';

import { useState } from 'react';
import { useParticipants } from '@/hooks/useParticipants';
import type { Participant } from '@/lib/db/types';

export function ParticipantPicker({
  selected,
  onChange
}: {
  selected: Participant[];
  onChange: (participants: Participant[]) => void;
}) {
  const { recent, frequent, loading } = useParticipants();
  const [showAllSuggestions, setShowAllSuggestions] = useState(false);
  const [newParticipantName, setNewParticipantName] = useState('');

  const handleSelect = (participant: Participant) => {
    // Toggle selection
    const isSelected = selected.some(p =>
      p.user_id === participant.user_id &&
      p.participant_id === participant.participant_id
    );

    if (isSelected) {
      onChange(selected.filter(p =>
        p.user_id !== participant.user_id ||
        p.participant_id !== participant.participant_id
      ));
    } else {
      onChange([...selected, participant]);
    }
  };

  const handleAddNew = () => {
    if (!newParticipantName.trim()) return;

    // Create new participant (non-registered)
    const newParticipant: Participant = {
      participant_id: crypto.randomUUID(),
      user_id: null,
      name: newParticipantName.trim(),
      email: null
    };

    onChange([...selected, newParticipant]);
    setNewParticipantName('');
  };

  return (
    <div className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          Who was involved?
        </label>

        {/* Selected participants */}
        {selected.length > 0 && (
          <div className="flex flex-wrap gap-2 mb-3">
            {selected.map(p => (
              <button
                key={p.user_id || p.participant_id}
                onClick={() => handleSelect(p)}
                className="px-3 py-1 bg-blue-500 text-white rounded-full text-sm"
              >
                {p.name} Ã—
              </button>
            ))}
          </div>
        )}

        {/* Recent suggestions (always show top 5) */}
        {!loading && recent.length > 0 && (
          <div className="mb-3">
            <p className="text-xs text-gray-500 mb-1">Recent</p>
            <div className="flex flex-wrap gap-2">
              {recent.slice(0, showAllSuggestions ? 10 : 5).map(p => {
                const isSelected = selected.some(s =>
                  s.user_id === p.user_id && s.participant_id === p.participant_id
                );

                return (
                  <button
                    key={p.user_id || p.participant_id}
                    onClick={() => handleSelect(p)}
                    className={`px-3 py-1 rounded-full text-sm ${
                      isSelected
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-300'
                    }`}
                  >
                    {p.name}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* Show more button */}
        {recent.length > 5 && (
          <button
            onClick={() => setShowAllSuggestions(!showAllSuggestions)}
            className="text-sm text-blue-600 mb-3"
          >
            {showAllSuggestions ? 'Show less' : 'Show more suggestions'}
          </button>
        )}

        {/* Add new participant */}
        <div className="flex gap-2">
          <input
            type="text"
            value={newParticipantName}
            onChange={(e) => setNewParticipantName(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleAddNew()}
            placeholder="Add someone new..."
            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
          />
          <button
            onClick={handleAddNew}
            disabled={!newParticipantName.trim()}
            className="px-4 py-2 bg-green-500 text-white rounded-lg disabled:opacity-50"
          >
            Add
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Features:**
- Shows recent participants (top 5, expandable to 10)
- Selected participants shown as removable chips
- Suggestions shown as toggleable buttons
- Add new participant inline
- Visual distinction between selected/unselected
- iOS-native button/input styling

**Interaction patterns:**
- Tap suggestion to add
- Tap selected chip to remove
- Type new name and press Enter or click Add
- Show more/less for suggestions

**Avoid:**
- DO NOT create participants in database yet (just state)
- DO NOT validate uniqueness (allow duplicate names)
- DO NOT require email for non-registered participants
- DO NOT fetch suggestions on every render (use hook's cached state)</action>
  <verify>TypeScript compiles, component renders with suggestions, selection/deselection works, can add new participants, iOS styling matches Phase 1</verify>
  <done>ParticipantPicker component created with smart suggestions, selection management, add new participant, iOS-native UI</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] useParticipants hook returns smart suggestions
- [ ] ParticipantPicker renders suggestions from recent expenses
- [ ] Can select/deselect participants
- [ ] Can add new participants inline
- [ ] iOS-native styling matches established patterns
</verification>

<success_criteria>
- useParticipants hook analyzes expense history for suggestions
- ParticipantPicker component shows recent/frequent participants
- Selection/deselection works via toggle
- Can add new non-registered participants
- iOS-native UI with proper touch targets
- No TypeScript errors
- Ready for split method integration (Plans 03-05)
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-expense-creation/04-02-SUMMARY.md`:

# Phase 4 Plan 2: Participant Picker Summary

**Smart participant suggestions with iOS-native selection UI**

## Accomplishments

- Created useParticipants hook analyzing expense history
- Implemented smart suggestions (recent + frequent)
- Built ParticipantPicker component with toggle selection
- Added inline participant creation for non-registered users
- iOS-native styling with proper touch interactions
- Handled hybrid user/participant model

## Files Created/Modified

- `hooks/useParticipants.ts` - Smart suggestion logic
- `components/ParticipantPicker.tsx` - Selection UI component

## Decisions Made

[Document suggestion algorithm, participant creation approach, or "None"]

## Issues Encountered

[Any issues with suggestion logic, performance, or "None"]

## Next Step

Ready for 04-03-PLAN.md (Split equally functionality)
</output>
