---
phase: 04-core-expense-creation
plan: 07
type: execute
depends_on: ["04-01", "04-06"]
files_modified: [app/expenses/page.tsx, app/expenses/[id]/page.tsx, components/ExpenseList.tsx, components/ExpenseDetail.tsx]
---

<objective>
Build expense list view with filtering and expense detail view with edit capability.

Purpose: Enable users to view, filter, and manage created expenses.
Output: Expense list page and detail/edit pages completing the CRUD cycle.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-data-model-and-offline-foundation/03-03-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-01-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-06-SUMMARY.md
@lib/db/stores.ts
@lib/db/types.ts
@hooks/useOptimisticMutation.ts
@components/ExpenseForm.tsx
@components/BottomNav.tsx

**Tech stack available:**
- IndexedDB with getExpenses, getExpenseParticipants, getExpenseSplits
- useOptimisticMutation for updates/deletes
- Framer Motion for transitions
- Next.js App Router with dynamic routes

**Established patterns:**
- List views with iOS-native styling
- Detail views with edit capability
- Optimistic updates for all mutations
- Bottom navigation structure

**Constraining decisions:**
- Phase 3: getExpenses supports filtering by tag, date range
- Phase 3: Soft deletes via is_deleted flag
- Plan 06: ExpenseForm supports create and edit
- PROJECT: Beautiful UX that makes expense management feel effortless
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create expense list view with filtering</name>
  <files>app/expenses/page.tsx, components/ExpenseList.tsx</files>
  <action>Build expense list with iOS-native design:

**ExpenseList component:**
```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { getExpenses, getExpenseParticipants } from '@/lib/db/stores';
import type { Expense, Participant } from '@/lib/db/types';
import { motion } from 'framer-motion';

export function ExpenseList() {
  const router = useRouter();
  const [expenses, setExpenses] = useState<(Expense & { participants: Participant[] })[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | '7days' | '30days' | 'tag'>('all');

  useEffect(() => {
    async function loadExpenses() {
      let query = {};

      if (filter === '7days') {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        query = { since: sevenDaysAgo.toISOString() };
      } else if (filter === '30days') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        query = { since: thirtyDaysAgo.toISOString() };
      }

      const items = await getExpenses(query);

      // Load participants for each expense
      const withParticipants = await Promise.all(
        items.map(async (expense) => ({
          ...expense,
          participants: await getExpenseParticipants(expense.id)
        }))
      );

      setExpenses(withParticipants);
      setLoading(false);
    }

    loadExpenses();
  }, [filter]);

  if (loading) {
    return <div className="p-4 text-center text-gray-500">Loading...</div>;
  }

  return (
    <div className="max-w-md mx-auto">
      {/* Filter tabs */}
      <div className="flex gap-2 p-4 overflow-x-auto">
        <button
          onClick={() => setFilter('all')}
          className={`px-4 py-2 rounded-full whitespace-nowrap ${
            filter === 'all'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          All
        </button>
        <button
          onClick={() => setFilter('7days')}
          className={`px-4 py-2 rounded-full whitespace-nowrap ${
            filter === '7days'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          Last 7 days
        </button>
        <button
          onClick={() => setFilter('30days')}
          className={`px-4 py-2 rounded-full whitespace-nowrap ${
            filter === '30days'
              ? 'bg-blue-500 text-white'
              : 'bg-gray-100 text-gray-700'
          }`}
        >
          Last 30 days
        </button>
      </div>

      {/* Expense list */}
      <div className="divide-y divide-gray-200">
        {expenses.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            No expenses yet. Tap + to create one.
          </div>
        ) : (
          expenses.map((expense) => (
            <motion.div
              key={expense.id}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="p-4 cursor-pointer hover:bg-gray-50 active:bg-gray-100"
              onClick={() => router.push(`/expenses/${expense.id}`)}
            >
              <div className="flex justify-between items-start mb-1">
                <h3 className="font-medium text-gray-900">{expense.description}</h3>
                <span className="font-semibold text-gray-900">
                  ${expense.amount.toFixed(2)}
                </span>
              </div>

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">{expense.category}</span>
                  <span className="text-sm text-gray-400">•</span>
                  <span className="text-sm text-gray-500">
                    {new Date(expense.expense_date).toLocaleDateString()}
                  </span>
                </div>

                {expense.participants.length > 0 && (
                  <div className="text-sm text-gray-500">
                    {expense.participants.length} {expense.participants.length === 1 ? 'person' : 'people'}
                  </div>
                )}
              </div>
            </motion.div>
          ))
        )}
      </div>

      {/* FAB (Floating Action Button) */}
      <button
        onClick={() => router.push('/expenses/new')}
        className="fixed bottom-20 right-4 w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl"
      >
        +
      </button>
    </div>
  );
}
```

**Page component:**
```tsx
// app/expenses/page.tsx
'use client';

import { ExpenseList } from '@/components/ExpenseList';

export default function ExpensesPage() {
  return (
    <div className="pb-safe">
      <h1 className="text-2xl font-semibold p-4">Expenses</h1>
      <ExpenseList />
    </div>
  );
}
```

**Features:**
- List all expenses sorted by date (most recent first)
- Filter by time range (all, last 7 days, last 30 days)
- Show description, amount, category, date, participant count
- Tap expense to view details
- FAB (Floating Action Button) to create new expense
- Framer Motion animations on list items
- iOS-native list styling with chevron indicators

**Avoid:**
- DO NOT fetch from Supabase (use IndexedDB only)
- DO NOT show deleted expenses (filter is_deleted = false)
- DO NOT load all expenses at once (use pagination in future)
- DO NOT forget pb-safe for bottom nav clearance</action>
  <verify>TypeScript compiles, list renders expenses from IndexedDB, filtering works, animations smooth, FAB navigates to create page, tapping expense navigates to detail</verify>
  <done>Expense list view created with filtering, iOS-native styling, FAB, navigation to detail/create</done>
</task>

<task type="auto">
  <name>Task 2: Create expense detail view with edit capability</name>
  <files>app/expenses/[id]/page.tsx, components/ExpenseDetail.tsx</files>
  <action>Build expense detail/edit view:

**ExpenseDetail component:**
```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { getExpense, getExpenseParticipants, getExpenseSplits } from '@/lib/db/stores';
import { useOptimisticMutation } from '@/hooks/useOptimisticMutation';
import type { Expense, Participant, ExpenseSplit } from '@/lib/db/types';
import { ExpenseForm } from './ExpenseForm';

export function ExpenseDetail({ id }: { id: string }) {
  const router = useRouter();
  const { updateExpense, deleteExpense } = useOptimisticMutation();
  const [expense, setExpense] = useState<Expense | null>(null);
  const [participants, setParticipants] = useState<Participant[]>([]);
  const [splits, setSplits] = useState<ExpenseSplit[]>([]);
  const [isEditing, setIsEditing] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadExpense() {
      const exp = await getExpense(id);
      if (!exp) {
        router.push('/expenses');
        return;
      }

      const parts = await getExpenseParticipants(id);
      const spl = await getExpenseSplits(id);

      setExpense(exp);
      setParticipants(parts);
      setSplits(spl);
      setLoading(false);
    }

    loadExpense();
  }, [id, router]);

  const handleUpdate = async (formData: any) => {
    try {
      await updateExpense(id, formData);
      setIsEditing(false);
      router.refresh();
    } catch (err) {
      console.error('Failed to update expense:', err);
    }
  };

  const handleDelete = async () => {
    if (!confirm('Delete this expense?')) return;

    try {
      await deleteExpense(id);
      router.push('/expenses');
    } catch (err) {
      console.error('Failed to delete expense:', err);
    }
  };

  if (loading) {
    return <div className="p-4 text-center text-gray-500">Loading...</div>;
  }

  if (!expense) {
    return <div className="p-4 text-center text-gray-500">Expense not found</div>;
  }

  if (isEditing) {
    return (
      <div className="max-w-md mx-auto p-4 pb-safe">
        <ExpenseForm
          initialData={{ ...expense, participants, splits }}
          onSubmit={handleUpdate}
          onCancel={() => setIsEditing(false)}
        />
      </div>
    );
  }

  return (
    <div className="max-w-md mx-auto p-4 pb-safe">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <button
          onClick={() => router.back()}
          className="text-blue-600"
        >
          ← Back
        </button>
        <div className="flex gap-2">
          <button
            onClick={() => setIsEditing(true)}
            className="px-4 py-2 text-blue-600"
          >
            Edit
          </button>
          <button
            onClick={handleDelete}
            className="px-4 py-2 text-red-600"
          >
            Delete
          </button>
        </div>
      </div>

      {/* Expense details */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-4">
        <h1 className="text-3xl font-semibold text-gray-900 mb-2">
          ${expense.amount.toFixed(2)} {expense.currency}
        </h1>
        <p className="text-lg text-gray-700 mb-4">{expense.description}</p>

        <div className="space-y-2 text-sm text-gray-600">
          <div className="flex justify-between">
            <span>Category</span>
            <span className="font-medium text-gray-900">{expense.category}</span>
          </div>
          <div className="flex justify-between">
            <span>Date</span>
            <span className="font-medium text-gray-900">
              {new Date(expense.expense_date).toLocaleDateString()}
            </span>
          </div>
        </div>
      </div>

      {/* Participants */}
      {participants.length > 0 && (
        <div className="bg-white rounded-lg shadow-sm p-6 mb-4">
          <h2 className="font-semibold text-gray-900 mb-3">Participants</h2>
          <div className="space-y-2">
            {participants.map(p => (
              <div key={p.user_id || p.participant_id} className="text-gray-700">
                {p.name}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Splits */}
      {splits.length > 0 && (
        <div className="bg-white rounded-lg shadow-sm p-6">
          <h2 className="font-semibold text-gray-900 mb-3">Split Details</h2>
          <div className="space-y-2">
            {splits.map(split => {
              const participant = participants.find(p =>
                p.user_id === split.user_id || p.participant_id === split.participant_id
              );

              return (
                <div key={split.id} className="flex justify-between items-center">
                  <span className="text-gray-700">{participant?.name || 'Unknown'}</span>
                  <div className="text-right">
                    <div className="font-medium text-gray-900">
                      ${split.amount.toFixed(2)}
                    </div>
                    {split.split_type !== 'equal' && (
                      <div className="text-xs text-gray-500">
                        {split.split_type === 'percentage' && `${split.split_value}%`}
                        {split.split_type === 'shares' && `${split.split_value} shares`}
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          <div className="mt-4 pt-4 border-t border-gray-200">
            <div className="flex justify-between font-semibold">
              <span>Total</span>
              <span>${splits.reduce((sum, s) => sum + s.amount, 0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

**Page component:**
```tsx
// app/expenses/[id]/page.tsx
'use client';

import { use } from 'react';
import { ExpenseDetail } from '@/components/ExpenseDetail';

export default function ExpenseDetailPage({
  params
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = use(params);
  return <ExpenseDetail id={id} />;
}
```

**Features:**
- Show complete expense details
- List participants and their split amounts
- Show split type (equal, percentage, shares)
- Edit button opens ExpenseForm in edit mode
- Delete button with confirmation
- Back navigation
- iOS-native card-style layout

**Avoid:**
- DO NOT forget to handle expense not found
- DO NOT allow editing without confirmation
- DO NOT delete without confirmation
- DO NOT forget to update ExpenseForm to support initialData prop</action>
  <verify>TypeScript compiles, detail page loads expense from IndexedDB, shows all details, edit mode works, delete works with confirmation, navigation functional</verify>
  <done>Expense detail view created with edit capability, delete confirmation, participant/split display, iOS-native styling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] Expense list loads and displays expenses from IndexedDB
- [ ] Filtering by time range works
- [ ] FAB navigates to create page
- [ ] Tapping expense navigates to detail page
- [ ] Detail page shows complete expense information
- [ ] Edit mode works
- [ ] Delete with confirmation works
- [ ] All navigation works correctly
</verification>

<success_criteria>
- Expense list view with filtering and FAB
- Expense detail view with complete information
- Edit capability integrated with ExpenseForm
- Delete with confirmation
- iOS-native styling throughout
- No TypeScript errors
- **Phase 4 complete** - Full CRUD cycle for expenses implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-expense-creation/04-07-SUMMARY.md`:

# Phase 4 Plan 7: Expense List and Detail Views Summary

**Complete expense browsing and management**

## Accomplishments

- Created expense list view with time-based filtering
- Implemented FAB for quick expense creation
- Built expense detail view with complete information
- Added edit capability reusing ExpenseForm
- Implemented delete with confirmation
- Handled all navigation flows
- iOS-native list and card layouts

## Files Created/Modified

- `app/expenses/page.tsx` - List page
- `components/ExpenseList.tsx` - List component
- `app/expenses/[id]/page.tsx` - Detail page
- `components/ExpenseDetail.tsx` - Detail component

## Decisions Made

[Document filtering approach, edit/delete UX patterns, or "None"]

## Issues Encountered

[Any issues with IndexedDB queries, navigation, or "None"]

## Next Step

**Phase 4 Complete!** Full expense CRUD cycle implemented.
Ready for Phase 5 (Tagging & Organization)
</output>
