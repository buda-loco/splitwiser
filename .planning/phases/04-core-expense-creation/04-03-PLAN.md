---
phase: 04-core-expense-creation
plan: 03
type: execute
depends_on: []
files_modified: [components/SplitEqual.tsx]
---

<objective>
Implement equal split functionality where expense is divided evenly among all participants.

Purpose: Enable the most common split method - divide total equally among everyone involved.
Output: SplitEqual component that automatically calculates even splits.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-data-model-and-offline-foundation/03-01-SUMMARY.md
@lib/db/types.ts

**Tech stack available:**
- React 19 with hooks
- TypeScript with strict type safety
- Tailwind CSS for styling

**Established patterns:**
- Split types: 'equal' | 'percentage' | 'shares' | 'exact' (from schema)
- Decimal(12,2) for money calculations
- iOS-native UI patterns

**Constraining decisions:**
- Phase 3: Split types defined in schema (equal, percentage, shares, exact)
- Phase 3: Amounts use decimal(12,2) for precision
- PROJECT: Beautiful UX that makes splitting feel effortless
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SplitEqual component with automatic calculation</name>
  <files>components/SplitEqual.tsx</files>
  <action>Create component that calculates equal splits automatically:

**Component structure:**
```tsx
'use client';

import { useMemo } from 'react';
import type { Participant, ExpenseSplit } from '@/lib/db/types';

export function SplitEqual({
  amount,
  participants,
  onChange
}: {
  amount: number;
  participants: Participant[];
  onChange: (splits: ExpenseSplit[]) => void;
}) {
  // Calculate equal split
  const splits = useMemo(() => {
    if (!amount || participants.length === 0) return [];

    // Divide amount equally
    const perPerson = amount / participants.length;

    // Handle rounding: distribute cents to first N people
    const baseAmount = Math.floor(perPerson * 100) / 100; // 2 decimal places
    const remainder = Math.round((amount - (baseAmount * participants.length)) * 100);

    return participants.map((participant, index) => ({
      id: crypto.randomUUID(),
      expense_id: '', // Will be filled when expense created
      user_id: participant.user_id,
      participant_id: participant.participant_id,
      amount: baseAmount + (index < remainder ? 0.01 : 0),
      split_type: 'equal' as const,
      split_value: null, // Not used for equal split
      created_at: new Date().toISOString()
    }));
  }, [amount, participants]);

  // Update parent when splits change
  useMemo(() => {
    onChange(splits);
  }, [splits, onChange]);

  // Verify total matches (should always be true)
  const total = splits.reduce((sum, split) => sum + split.amount, 0);
  const matches = Math.abs(total - amount) < 0.01;

  return (
    <div className="space-y-3">
      <h3 className="font-medium text-gray-900">Split Equally</h3>

      {/* Show per-person amount */}
      {participants.length > 0 && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <p className="text-sm text-blue-900">
            ${(amount / participants.length).toFixed(2)} per person
          </p>
        </div>
      )}

      {/* Show breakdown */}
      <div className="space-y-2">
        {splits.map((split, index) => {
          const participant = participants[index];
          return (
            <div
              key={split.id}
              className="flex justify-between items-center py-2 border-b border-gray-200 last:border-0"
            >
              <span className="text-gray-900">{participant.name}</span>
              <span className="font-medium text-gray-900">
                ${split.amount.toFixed(2)}
              </span>
            </div>
          );
        })}
      </div>

      {/* Total verification (should always match) */}
      {!matches && (
        <div className="text-xs text-red-600">
          Warning: Total ${total.toFixed(2)} doesn't match amount ${amount.toFixed(2)}
        </div>
      )}

      {/* Summary */}
      <div className="pt-2 border-t border-gray-300">
        <div className="flex justify-between font-semibold">
          <span>Total</span>
          <span>${total.toFixed(2)}</span>
        </div>
      </div>
    </div>
  );
}
```

**Rounding strategy:**
- Divide amount by participant count
- Round base amount to 2 decimals
- Distribute remainder cents to first N people
- Example: $10 / 3 = $3.33, $3.33, $3.34 (total $10.00)

**Features:**
- Automatic calculation on amount/participant changes
- Shows per-person average
- Lists each person's amount
- Verifies total matches input amount
- iOS-native styling

**Avoid:**
- DO NOT allow manual editing of individual splits (equal = automatic)
- DO NOT use floating point without rounding (causes $9.99 != $10.00 issues)
- DO NOT create splits if no participants selected
- DO NOT create splits if amount is 0 or negative</action>
  <verify>TypeScript compiles, component calculates equal splits correctly, rounding distributes cents properly, total always matches input amount</verify>
  <done>SplitEqual component created with automatic equal division, proper rounding, iOS-native UI, total verification</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for split calculation logic</name>
  <files>components/__tests__/SplitEqual.test.ts</files>
  <action>Create tests verifying split calculation accuracy:

**Test cases:**
```typescript
import { describe, it, expect } from '@jest/globals';
// Import calculation logic extracted from component

describe('Equal split calculations', () => {
  it('divides evenly when amount divides perfectly', () => {
    // $12 / 3 people = $4.00 each
    const splits = calculateEqualSplits(12, 3);
    expect(splits).toEqual([4.00, 4.00, 4.00]);
    expect(sum(splits)).toBe(12.00);
  });

  it('distributes remainder cents to first people', () => {
    // $10 / 3 people = $3.33, $3.33, $3.34
    const splits = calculateEqualSplits(10, 3);
    expect(splits[0]).toBe(3.33);
    expect(splits[1]).toBe(3.33);
    expect(splits[2]).toBe(3.34);
    expect(sum(splits)).toBe(10.00);
  });

  it('handles single participant', () => {
    const splits = calculateEqualSplits(15.50, 1);
    expect(splits).toEqual([15.50]);
  });

  it('handles many participants', () => {
    const splits = calculateEqualSplits(100, 7);
    expect(sum(splits)).toBe(100.00);
    expect(splits.every(s => s > 14 && s < 15)).toBe(true);
  });

  it('handles zero amount', () => {
    const splits = calculateEqualSplits(0, 3);
    expect(splits).toEqual([0, 0, 0]);
  });
});
```

**If no test framework exists:**
Skip this task for now (can add tests later). Focus on Plan 03-05 implementation.

**Avoid:**
- DO NOT test React component rendering (test calculation logic only)
- DO NOT mock participant objects (use plain number calculations)</action>
  <verify>Tests pass if framework exists, or skip if no test setup</verify>
  <done>Unit tests created for split calculation logic, or skipped if no test framework</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] SplitEqual component calculates correct amounts
- [ ] Rounding distributes cents properly
- [ ] Total always matches input amount (no rounding errors)
- [ ] Component updates when amount or participants change
- [ ] Tests pass (if test framework exists)
</verification>

<success_criteria>
- SplitEqual component automatically calculates even splits
- Rounding strategy ensures total always matches
- iOS-native UI matches established patterns
- Component integrates with ExpenseSplit type from schema
- No floating point precision issues
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-expense-creation/04-03-SUMMARY.md`:

# Phase 4 Plan 3: Split Equally Summary

**Automatic equal division with proper rounding**

## Accomplishments

- Created SplitEqual component with automatic calculation
- Implemented rounding strategy to distribute remainder cents
- Built verification to ensure total always matches
- Added iOS-native UI showing per-person amounts
- Handled edge cases (0 participants, 0 amount, single person)

## Files Created/Modified

- `components/SplitEqual.tsx` - Equal split component
- `components/__tests__/SplitEqual.test.ts` - Unit tests (if created)

## Decisions Made

[Document rounding strategy, cent distribution approach]

## Issues Encountered

[Any floating point precision issues resolved, or "None"]

## Next Step

Independent of 04-04 and 04-05 (percentage/shares splits)
</output>
