---
phase: 04-core-expense-creation
plan: 06
type: execute
depends_on: ["04-01", "04-02", "04-03", "04-04", "04-05"]
files_modified: [app/expenses/new/page.tsx, components/ExpenseForm.tsx]
---

<objective>
Integrate participant picker and all split methods into complete expense creation flow.

Purpose: Combine all components into cohesive multi-step expense creation experience.
Output: Complete expense creation flow from amount → participants → split method → save.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-expense-creation/04-01-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-02-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-03-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-04-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-05-SUMMARY.md
@components/ExpenseForm.tsx
@components/ParticipantPicker.tsx
@components/SplitEqual.tsx
@components/SplitByPercentage.tsx
@components/SplitByShares.tsx
@hooks/useOptimisticMutation.ts
@lib/db/stores.ts
@lib/db/types.ts

**Tech stack available:**
- All split components from Plans 03-05
- ParticipantPicker from Plan 02
- ExpenseForm from Plan 01
- OptimisticUpdateManager for instant saves
- Framer Motion for transitions

**Established patterns:**
- Multi-step forms with iOS-native navigation
- Optimistic updates for instant feedback
- Bottom-sheet style modals

**Constraining decisions:**
- Phase 3: Expense creation requires participants and splits
- Plans 01-05: All component APIs defined
- PROJECT: Beautiful UX that makes splitting feel effortless
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ExpenseForm to include participant selection and split method</name>
  <files>components/ExpenseForm.tsx, app/expenses/new/page.tsx</files>
  <action>Integrate all components into cohesive flow:

**Update ExpenseForm to include participants and splits:**

```tsx
'use client';

import { useState } from 'react';
import { ParticipantPicker } from './ParticipantPicker';
import { SplitEqual } from './SplitEqual';
import { SplitByPercentage } from './SplitByPercentage';
import { SplitByShares } from './SplitByShares';
import type { Participant, ExpenseSplit } from '@/lib/db/types';

type SplitMethod = 'equal' | 'percentage' | 'shares' | 'exact';

export function ExpenseForm({
  onSubmit,
  onCancel
}: {
  onSubmit: (data: {
    amount: number;
    currency: string;
    description: string;
    category: string;
    expense_date: string;
    participants: Participant[];
    splits: ExpenseSplit[];
  }) => void;
  onCancel?: () => void;
}) {
  // Existing form state from Plan 01
  const [amount, setAmount] = useState('');
  const [currency, setCurrency] = useState('AUD');
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('');
  const [expenseDate, setExpenseDate] = useState(
    new Date().toISOString().split('T')[0]
  );

  // New state for participants and splits
  const [participants, setParticipants] = useState<Participant[]>([]);
  const [splitMethod, setSplitMethod] = useState<SplitMethod>('equal');
  const [splits, setSplits] = useState<ExpenseSplit[]>([]);

  // Multi-step navigation
  const [step, setStep] = useState<'basic' | 'participants' | 'splits'>('basic');

  // Validation
  const basicValid = amount && parseFloat(amount) > 0 && description && category;
  const participantsValid = participants.length > 0;
  const splitsValid = splits.length > 0 &&
    Math.abs(splits.reduce((sum, s) => sum + s.amount, 0) - parseFloat(amount)) < 0.01;

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();

    if (step === 'basic' && basicValid) {
      setStep('participants');
    } else if (step === 'participants' && participantsValid) {
      setStep('splits');
    } else if (step === 'splits' && splitsValid) {
      onSubmit({
        amount: parseFloat(amount),
        currency,
        description,
        category,
        expense_date: expenseDate,
        participants,
        splits
      });
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Step indicator */}
      <div className="flex justify-between mb-6">
        <div className={`flex-1 h-1 rounded ${step === 'basic' ? 'bg-blue-500' : 'bg-gray-300'}`} />
        <div className={`flex-1 h-1 rounded mx-2 ${step === 'participants' ? 'bg-blue-500' : 'bg-gray-300'}`} />
        <div className={`flex-1 h-1 rounded ${step === 'splits' ? 'bg-blue-500' : 'bg-gray-300'}`} />
      </div>

      {/* Step 1: Basic info */}
      {step === 'basic' && (
        <div className="space-y-4">
          {/* Existing fields from Plan 01 */}
          {/* amount, currency, description, category, date */}
        </div>
      )}

      {/* Step 2: Participants */}
      {step === 'participants' && (
        <div>
          <button
            type="button"
            onClick={() => setStep('basic')}
            className="mb-4 text-blue-600"
          >
            ← Back
          </button>

          <ParticipantPicker
            selected={participants}
            onChange={setParticipants}
          />
        </div>
      )}

      {/* Step 3: Split method */}
      {step === 'splits' && (
        <div>
          <button
            type="button"
            onClick={() => setStep('participants')}
            className="mb-4 text-blue-600"
          >
            ← Back
          </button>

          {/* Split method selector */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              How to split?
            </label>
            <div className="flex gap-2">
              <button
                type="button"
                onClick={() => setSplitMethod('equal')}
                className={`px-4 py-2 rounded-lg ${
                  splitMethod === 'equal'
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-100 text-gray-700'
                }`}
              >
                Equally
              </button>
              <button
                type="button"
                onClick={() => setSplitMethod('percentage')}
                className={`px-4 py-2 rounded-lg ${
                  splitMethod === 'percentage'
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-100 text-gray-700'
                }`}
              >
                By %
              </button>
              <button
                type="button"
                onClick={() => setSplitMethod('shares')}
                className={`px-4 py-2 rounded-lg ${
                  splitMethod === 'shares'
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-100 text-gray-700'
                }`}
              >
                By Shares
              </button>
            </div>
          </div>

          {/* Split component */}
          {splitMethod === 'equal' && (
            <SplitEqual
              amount={parseFloat(amount)}
              participants={participants}
              onChange={setSplits}
            />
          )}
          {splitMethod === 'percentage' && (
            <SplitByPercentage
              amount={parseFloat(amount)}
              participants={participants}
              onChange={setSplits}
            />
          )}
          {splitMethod === 'shares' && (
            <SplitByShares
              amount={parseFloat(amount)}
              participants={participants}
              onChange={setSplits}
            />
          )}
        </div>
      )}

      {/* Navigation buttons */}
      <div className="flex gap-3 pt-4">
        {onCancel && (
          <button
            type="button"
            onClick={onCancel}
            className="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700"
          >
            Cancel
          </button>
        )}
        <button
          type="submit"
          disabled={
            (step === 'basic' && !basicValid) ||
            (step === 'participants' && !participantsValid) ||
            (step === 'splits' && !splitsValid)
          }
          className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg disabled:opacity-50"
        >
          {step === 'splits' ? 'Create Expense' : 'Next'}
        </button>
      </div>
    </form>
  );
}
```

**Update page to handle complete submission:**

```tsx
// In app/expenses/new/page.tsx

const handleSubmit = async (formData) => {
  try {
    const currentUserId = 'temp-user-id'; // TODO: Get from auth

    // Create expense with optimistic update
    const expenseId = await createExpense({
      ...formData,
      paid_by_user_id: currentUserId,
      created_by_user_id: currentUserId
    });

    // Add participants to IndexedDB
    for (const participant of formData.participants) {
      await addParticipantToExpense(expenseId, participant);
    }

    // Add splits to IndexedDB
    for (const split of formData.splits) {
      await createSplit({ ...split, expense_id: expenseId });
    }

    router.push('/expenses');
  } catch (err) {
    console.error('Failed to create expense:', err);
  }
};
```

**Features:**
- 3-step flow: Basic info → Participants → Split method
- Step indicator showing progress
- Back navigation between steps
- Split method selector (equal/percentage/shares)
- Validation at each step
- Final submission creates expense + participants + splits

**Avoid:**
- DO NOT allow skipping steps (validate each before next)
- DO NOT lose form data when navigating back
- DO NOT submit if splits don't total to amount
- DO NOT forget to add 'use client' directive</action>
  <verify>TypeScript compiles, 3-step flow works, can navigate back/forward, split methods integrate correctly, submission creates expense with participants and splits</verify>
  <done>Expense creation flow integrated with all components, 3-step navigation, split method selection, complete optimistic submission</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] 3-step flow works (basic → participants → splits)
- [ ] Can navigate back without losing data
- [ ] All split methods selectable and functional
- [ ] Validation prevents invalid progression
- [ ] Submission creates expense + participants + splits in IndexedDB
</verification>

<success_criteria>
- Complete expense creation flow with 3 steps
- All components integrated seamlessly
- Step validation prevents invalid submissions
- Split method selection works
- Optimistic creation with participants and splits
- iOS-native multi-step UX
- No TypeScript errors
- Ready for expense list view (Plan 07)
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-expense-creation/04-06-SUMMARY.md`:

# Phase 4 Plan 6: Expense Creation Flow Integration Summary

**Complete multi-step expense creation with all split methods**

## Accomplishments

- Integrated all components into 3-step flow
- Added step indicator and navigation
- Built split method selector
- Implemented validation at each step
- Created complete optimistic submission
- Handled expense + participants + splits creation

## Files Created/Modified

- `components/ExpenseForm.tsx` - Multi-step form
- `app/expenses/new/page.tsx` - Complete submission logic

## Decisions Made

[Document step flow, validation rules, submission order]

## Issues Encountered

[Any integration issues, state management challenges, or "None"]

## Next Step

Ready for 04-07-PLAN.md (Expense list and detail views)
</output>
