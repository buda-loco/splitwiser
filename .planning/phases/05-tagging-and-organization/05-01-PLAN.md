---
phase: 05-tagging-and-organization
plan: 01
type: execute
depends_on: []
files_modified: [components/ExpenseForm.tsx, components/TagInput.tsx]
---

<objective>
Add tag input component with autocomplete to expense creation flow.

Purpose: Enable users to organize expenses with tags during creation, with suggestions based on previously used tags.
Output: Tag input component integrated into ExpenseForm, tags saved to expense_tags store on submission.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work
@.planning/phases/04-core-expense-creation/04-01-SUMMARY.md
@.planning/phases/04-core-expense-creation/04-06-SUMMARY.md

# Key files
@components/ExpenseForm.tsx
@lib/db/types.ts
@lib/db/stores.ts

**Tech stack available:** Next.js 15, TypeScript, Tailwind, Framer Motion, IndexedDB
**Established patterns:** Multi-step forms, iOS-native styling, optimistic updates
**Constraining decisions:**
- Phase 4: ExpenseForm uses 3-step flow (basic → participants → splits)
- Phase 3: IndexedDB stores with expense_tags store already configured
- All components: iOS-native design tokens (ios-blue, ios-gray, ios-red)

**Database operations available:**
- addTagToExpense(expense_id, tag) - normalizes to lowercase, prevents duplicates
- getExpenseTags(expense_id) - returns array of tag strings
- removeTagFromExpense(expense_id, tag_id) - removes specific tag
- getAllTags() - returns all unique tags across all expenses
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TagInput component with autocomplete</name>
  <files>components/TagInput.tsx</files>
  <action>
Create a TagInput component that:
- Accepts tags: string[] and onChange: (tags: string[]) => void props
- Shows existing tags as removable chips with iOS-native pill styling (rounded-full, bg-ios-blue/10, text-ios-blue)
- Input field for adding new tags (iOS-native text input styling)
- Shows autocomplete dropdown when typing (fetches from getAllTags(), filters by input, max 5 suggestions)
- Adds tag on Enter key, comma, or selecting from dropdown
- Normalizes tags to lowercase before adding (consistent with addTagToExpense)
- Prevents duplicate tags (case-insensitive)
- Dark mode support (bg-gray-800, text-white, border-gray-700)
- Framer Motion animations for tag chips and dropdown

Technical notes:
- Use useState for input value and suggestions
- Debounce autocomplete loading (300ms) to avoid excessive database calls
- Click outside closes dropdown (useEffect with document listener)
- Tag chips have X button for removal
- Dropdown positioned absolutely below input, z-index: 50
  </action>
  <verify>TypeScript compiles without errors. Component renders with tag chips, input field, and autocomplete dropdown when typing.</verify>
  <done>TagInput component exists with autocomplete, tag chip display, add/remove functionality, and iOS-native styling.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate TagInput into ExpenseForm</name>
  <files>components/ExpenseForm.tsx</files>
  <action>
Update ExpenseForm to include tag input:
- Add tags: string[] to ExpenseFormData type
- Add tags state: useState&lt;string[]&gt;(initialData?.tags || [])
- Add TagInput to the "basic" step AFTER the date field, BEFORE the step navigation buttons
- Pass tags and setTags to TagInput component
- Update handleSubmit to include tags in submission data: onSubmit({ ...expenseFormData, tags })
- Update initialData handling to populate tags if provided

Do NOT create separate tag step - tags belong in the "basic" step for quick entry.
Do NOT add validation for tags - they are optional.
  </action>
  <verify>ExpenseForm renders with TagInput in basic step. Can add/remove tags. Form submission includes tags array in data.</verify>
  <done>ExpenseForm includes TagInput component, tags are part of form state, and tags are submitted with expense data.</done>
</task>

<task type="auto">
  <name>Task 3: Save tags to database on expense submission</name>
  <files>app/expenses/new/page.tsx, app/expenses/[id]/page.tsx</files>
  <action>
Update expense submission logic to save tags:

In app/expenses/new/page.tsx:
- After createExpense() and adding participants/splits, loop through formData.tags
- For each tag, call addTagToExpense(expense.id, tag)
- Handle errors gracefully (log but don't block submission)

In app/expenses/[id]/page.tsx (edit mode):
- After updateExpense(), get existing tags with getExpenseTags(expense.id)
- Remove tags that are no longer in formData.tags: for each removed tag, call removeTagFromExpense()
- Add new tags that weren't in existing tags: call addTagToExpense()

Why NOT delete all and re-add: Preserves tag IDs, reduces database operations, better for sync later.
  </action>
  <verify>Create expense with tags, verify tags saved to expense_tags store. Edit expense tags, verify tags updated correctly (removed/added as needed).</verify>
  <done>Expense creation saves tags to database. Expense editing correctly updates tags (adds new, removes deleted). Tags persist across page reloads.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] TagInput component renders with autocomplete
- [ ] Can add tags via Enter, comma, or dropdown selection
- [ ] Can remove tags by clicking X on chip
- [ ] Tags appear in ExpenseForm basic step
- [ ] Creating expense saves tags to expense_tags store
- [ ] Editing expense updates tags correctly
- [ ] Autocomplete shows previously used tags
- [ ] Dark mode styling works on all tag components
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Tags can be added, displayed, and removed in expense form
- Tags are persisted to IndexedDB on create and update
- Autocomplete suggests previously used tags
- iOS-native styling throughout
</success_criteria>

<output>
After completion, create `.planning/phases/05-tagging-and-organization/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Tag Input with Autocomplete Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-02-PLAN.md (Tag filtering on expense list)
</output>
