---
phase: 05-tagging-and-organization
plan: 03
type: execute
depends_on: ["05-01"]
files_modified: [hooks/useParticipants.ts, hooks/useTagSuggestions.ts]
---

<objective>
Build smart participant suggestions based on tag history for faster expense entry.

Purpose: Auto-suggest participants based on tags (e.g., "Tokyo Trip" tag always suggests same travel group), reducing data entry time.
Output: useTagSuggestions hook that suggests participants when tag is selected, integrated into ParticipantPicker.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work
@.planning/phases/04-core-expense-creation/04-02-SUMMARY.md
@.planning/phases/05-tagging-and-organization/05-01-SUMMARY.md

# Key files
@hooks/useParticipants.ts
@components/ParticipantPicker.tsx
@lib/db/stores.ts

**Tech stack available:** Next.js 15, TypeScript, Tailwind, Framer Motion, IndexedDB
**Established patterns:** Smart suggestions based on history analysis, React hooks for data loading
**Constraining decisions:**
- Phase 4: useParticipants analyzes last 50 expenses for recent/frequent suggestions
- Phase 5-01: Tags are part of expense creation flow

**Database operations available:**
- getExpenses(filters: { tag? }) - returns expenses filtered by tag
- getExpenseParticipants(expense_id) - returns participants for expense
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTagSuggestions hook</name>
  <files>hooks/useTagSuggestions.ts</files>
  <action>
Create a hook that suggests participants based on tag selection:

```typescript
export function useTagSuggestions(selectedTags: string[]) {
  const [suggestedParticipants, setSuggestedParticipants] = useState<ParticipantWithDetails[]>([])
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (selectedTags.length === 0) {
      setSuggestedParticipants([])
      return
    }

    async function loadSuggestions() {
      // 1. Get expenses for the first selected tag (most recent tag)
      const taggedExpenses = await getExpenses({ tag: selectedTags[0] })

      // 2. Extract participants from these expenses
      const participantIds = new Set<string>()
      for (const expense of taggedExpenses) {
        const participants = await getExpenseParticipants(expense.id)
        participants.forEach(p => {
          const id = p.user_id || p.participant_id
          if (id) participantIds.add(id)
        })
      }

      // 3. Count frequency of each participant
      const frequency = new Map<string, number>()
      participantIds.forEach(id => {
        // Count how many expenses this participant appears in
        const count = taggedExpenses.filter(exp =>
          exp.participants?.some(p => (p.user_id || p.participant_id) === id)
        ).length
        frequency.set(id, count)
      })

      // 4. Return participants sorted by frequency (most common first)
      const sorted = Array.from(participantIds)
        .sort((a, b) => (frequency.get(b) || 0) - (frequency.get(a) || 0))

      // 5. Map to ParticipantWithDetails (temporary display names until sync)
      const details = sorted.map(id => ({
        user_id: id.startsWith('user-') ? id : null,
        participant_id: id.startsWith('participant-') ? id : null,
        name: `Participant ${id.slice(0, 8)}`,
        email: null
      }))

      setSuggestedParticipants(details)
    }

    setLoading(true)
    loadSuggestions().finally(() => setLoading(false))
  }, [selectedTags])

  return { suggestedParticipants, loading }
}
```

Why analyze only first tag: Most tags are mutually exclusive (trip tags, group tags). First tag is primary context.
Why frequency-based: People who appear in most expenses for this tag are core group members.
  </action>
  <verify>Hook returns empty array when no tags selected. Returns suggested participants when tag is selected. Participants sorted by frequency in tag context.</verify>
  <done>useTagSuggestions hook exists, analyzes tag history, returns participant suggestions sorted by frequency.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate tag-based suggestions into ParticipantPicker</name>
  <files>components/ParticipantPicker.tsx</files>
  <action>
Update ParticipantPicker to show tag-based suggestions:

1. Accept new prop: selectedTags?: string[]
2. Import useTagSuggestions hook
3. Call hook: const { suggestedParticipants: tagSuggestions } = useTagSuggestions(selectedTags || [])
4. Update suggestion display logic:
   - If tagSuggestions.length > 0, show section "Suggested for '[tag]'" with tag suggestions FIRST
   - Then show existing "Recent" and "Frequent" sections from useParticipants
   - Section header styling: text-xs font-semibold text-gray-500 dark:text-gray-400, mb-2
5. Highlight tag suggestions differently: border-2 border-ios-blue (vs border-1 for other suggestions)

Why tag suggestions first: Tag context is stronger signal than recency. If user selected a tag, they want that group.
Why highlight differently: Users need to see these are special suggestions based on their tag selection.
  </action>
  <verify>ParticipantPicker shows tag suggestions when selectedTags prop provided. Tag suggestions appear first with "Suggested for '[tag]'" header. Other suggestions still visible below.</verify>
  <done>ParticipantPicker displays tag-based suggestions first when tags selected. Visual hierarchy shows tag suggestions as primary.</done>
</task>

<task type="auto">
  <name>Task 3: Connect ExpenseForm tags to ParticipantPicker</name>
  <files>components/ExpenseForm.tsx</files>
  <action>
Update ExpenseForm to pass tags to ParticipantPicker:

In the "participants" step:
- Pass selectedTags={tags} prop to ParticipantPicker component
- This enables tag-based suggestions when user selects tags in basic step

Flow: User adds tags in step 1 (basic) → proceeds to step 2 (participants) → sees suggested participants based on tags
  </action>
  <verify>Adding tags in basic step shows tag-based participant suggestions in participants step. Removing tags removes tag suggestions.</verify>
  <done>ExpenseForm passes tags to ParticipantPicker. Tag-based suggestions appear automatically when tags are selected. Full flow works seamlessly.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors (npx tsc --noEmit)
- [ ] useTagSuggestions hook returns suggestions based on tag
- [ ] ParticipantPicker shows tag suggestions when selectedTags provided
- [ ] Tag suggestions appear FIRST in suggestion list
- [ ] Tag suggestions highlighted with blue border
- [ ] ExpenseForm passes tags to ParticipantPicker
- [ ] Adding tag in step 1 shows suggestions in step 2
- [ ] Suggestions sorted by frequency in tag context
- [ ] Other suggestions (recent/frequent) still visible
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Tag-based participant suggestions work end-to-end
- Suggestions prioritize tag context over recency
- iOS-native styling throughout
- Smooth integration with existing form flow
</success_criteria>

<output>
After completion, create `.planning/phases/05-tagging-and-organization/05-03-SUMMARY.md`
</output>
